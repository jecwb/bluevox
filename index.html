<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1DB954">
    <meta name="description" content="Repert√≥rio de m√∫sicas - BlueVox">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>BlueVox ¬∑ Repert√≥rio</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <style>
        /* RESET MODERNO */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* VARI√ÅVEIS GLOBAIS (tema dark moderno) */
        :root {
            --bg-primary: #0A0A0A;        /* fundo principal mais profundo */
            --bg-secondary: #1A1A1A;       /* cards e se√ß√µes */
            --bg-tertiary: #2A2A2A;         /* hover e elementos ativos */
            --accent-primary: #1DB954;      /* verde Spotify */
            --accent-secondary: #179443;    /* hover */
            --accent-blue: #3B71F3;          /* notas */
            --accent-orange: #F97316;        /* cifras */
            --accent-yellow: #FFD966;         /* destaque amarelo */
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --border-subtle: #333333;
            --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.5);
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --transition-smooth: all 0.2s ease;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-main);
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* MODERNOS BOT√ïES E ELEMENTOS */
        .btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            padding: 14px 20px;
            border-radius: 40px;           /* completamente arredondado */
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            letter-spacing: 0.3px;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.02);
            border-color: var(--accent-primary);
        }

        .btn-add {
            background: var(--accent-primary);
            color: #000000;
            font-weight: 700;
            border: none;
        }

        .btn-add:hover {
            background: var(--accent-secondary);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-subtle);
        }

        .btn-delete {
            background: #2E1A1A;
            border-color: #942828;
            color: #FF6B6B;
        }

        .btn-install {
            background: var(--accent-blue);
            color: white;
            border: none;
        }

        /* EMPTY STATE MODERNO */
        .empty-state {
            text-align: center;
            background: linear-gradient(145deg, var(--bg-secondary), #151515);
            border-radius: 32px;
            padding: 48px 24px;
            margin: 20px 0;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-subtle);
        }

        .empty-state h2 {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto 24px;
        }

        /* LISTA DE M√öSICAS - CARD MODERNO */
        .music-list {
            margin: 24px 0;
        }

        .music-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition-smooth);
            cursor: pointer;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .music-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateX(8px);
            box-shadow: 0 6px 18px rgba(29, 185, 84, 0.2);
        }

        .music-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .music-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 12px;
        }

        .music-bpm {
            background: rgba(29, 185, 84, 0.15);
            color: var(--accent-primary);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 40px;
            white-space: nowrap;
            border: 1px solid rgba(29, 185, 84, 0.3);
        }

        .music-notes {
            background: rgba(59, 113, 243, 0.15);
            color: var(--accent-blue);
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 40px;
            border: 1px solid rgba(59, 113, 243, 0.3);
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .music-notes:hover {
            background: rgba(59, 113, 243, 0.3);
            transform: scale(1.05);
        }

        .music-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        .setlist-btn.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }

        /* SE√á√ïES EXPANS√çVEIS MODERNAS */
        .expandable-section {
            background: var(--bg-secondary);
            border-radius: 24px;
            margin-bottom: 12px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            transition: var(--transition-smooth);
        }

        .section-header {
            padding: 18px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            transition: var(--transition-smooth);
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .section-header h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .section-header .arrow {
            color: var(--text-secondary);
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .section-header.expanded .arrow {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0 20px;
        }

        .section-content.expanded {
            max-height: 600px;
            padding: 0 20px 20px;
        }

        /* RODAP√â */
        .footer {
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-align: center;
        }

        .footer-info {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .music-count-footer {
            color: var(--accent-primary);
            font-weight: 700;
        }

        /* MODAL MODERNO */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
        }

        .modal-content {
            background: var(--bg-primary);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .modal-header {
            padding: 12px 16px;
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .modal-title-container h2 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .separator {
            color: var(--text-secondary);
        }

        .font-btn, .scroll-btn, .speed-btn, .view-mode-btn, .metronome-btn, .vs-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .font-btn:hover, .scroll-btn:hover, .view-mode-btn:hover, .metronome-btn:hover, .vs-btn:hover {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }

        .active {
            background: var(--accent-primary) !important;
            color: #000 !important;
            border-color: var(--accent-primary) !important;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            -webkit-overflow-scrolling: touch;
        }

        .lyrics-content {
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            text-transform: uppercase;
            text-align: center;
            font-size: 15px;
            padding: 20px 12px;
            color: var(--text-primary);
            max-width: 800px;
            margin: 0 auto;
        }

        .lyrics-content.landscape {
            column-count: 2;
            column-gap: 40px;
            text-align: left;
            font-size: 20px;
        }

        .yellow-line {
            color: var(--accent-yellow) !important;
            font-weight: 700;
            margin: 12px 0;
            text-shadow: 0 2px 5px rgba(255, 217, 102, 0.2);
        }

        .orange-chord {
            color: var(--accent-orange) !important;
            font-weight: 700;
            background: rgba(249, 115, 22, 0.1);
            padding: 0 4px;
            border-radius: 4px;
        }

        .normal-line {
            margin: 8px 0;
            color: var(--text-primary);
        }

        /* FORMUL√ÅRIOS MODERNOS */
        .add-form, .edit-form, .config-form {
            background: var(--bg-secondary);
            border-radius: 28px;
            padding: 24px;
            max-width: 600px;
            margin: 20px auto;
            border: 1px solid var(--border-subtle);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 16px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 40px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition-smooth);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.2);
        }

        .form-textarea {
            border-radius: 24px;
            min-height: 150px;
            resize: vertical;
        }

        /* AFINADOR MODERNO */
        .tuner-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .tuner-strings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
            margin: 30px 0;
        }

        .string-btn {
            background: linear-gradient(145deg, var(--bg-secondary), #1F1F1F);
            border: 1px solid var(--border-subtle);
            border-radius: 60px;
            padding: 24px 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            box-shadow: 0 8px 0 #0F0F0F;
        }

        .string-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 0 #0F0F0F;
            border-color: var(--accent-primary);
        }

        .string-btn.playing {
            background: var(--accent-primary);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 10px 0 #0F0F0F;
        }

        .string-note {
            font-size: 2.2rem;
            font-weight: 800;
        }

        /* METR√îNOMO INDEPENDENTE */
        .metronome-container {
            padding: 24px;
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .bpm-input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .bpm-input {
            width: 100px;
            padding: 16px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 60px;
            color: var(--accent-primary);
            font-size: 2rem;
            font-weight: 700;
        }

        .metronome-beat {
            font-size: 5rem;
            color: var(--accent-primary);
            transition: 0.1s;
        }

        .metronome-beat.active {
            color: var(--accent-yellow);
            transform: scale(1.3);
        }

        /* BOT√ïES FLUTUANTES */
        .notes-float-btn {
            position: fixed;
            bottom: 130px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 60px;
            background: var(--accent-blue);
            color: white;
            border: 3px solid var(--bg-primary);
            box-shadow: 0 8px 20px rgba(59, 113, 243, 0.4);
            cursor: pointer;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
            z-index: 1001;
        }

        .notes-float-btn:hover {
            transform: scale(1.1);
            background: #4F7FF5;
        }

        .vs-float-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 80px;
            background: linear-gradient(145deg, var(--accent-primary), #0F8F4C);
            color: #000;
            border: 3px solid var(--bg-primary);
            box-shadow: 0 10px 25px rgba(29, 185, 84, 0.5);
            cursor: pointer;
            font-size: 1.8rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
            z-index: 1001;
        }

        .vs-float-btn:hover {
            transform: scale(1.1);
            background: var(--accent-secondary);
        }

        .vs-float-btn.playing {
            background: #F93A3A;
            color: white;
            animation: pulseRed 1s infinite;
        }

        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(249, 58, 58, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(249, 58, 58, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 58, 58, 0); }
        }

        .notes-bubble {
            position: fixed;
            bottom: 210px;
            right: 25px;
            max-width: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 24px 24px 8px 24px;
            padding: 18px;
            color: var(--text-primary);
            z-index: 1002;
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }

        /* SETLIST MODERNO */
        .setlist-container {
            background: var(--bg-secondary);
            border-radius: 28px;
            padding: 24px;
            margin: 20px 0;
            border: 1px solid var(--border-subtle);
        }

        .setlist-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 40px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid transparent;
        }

        .setlist-item:hover {
            border-color: var(--accent-primary);
            background: #2F2F2F;
        }

        .setlist-item.active {
            background: rgba(29, 185, 84, 0.2);
            border-color: var(--accent-primary);
        }

        .setlist-pos {
            width: 32px;
            height: 32px;
            background: var(--accent-primary);
            color: #000;
            font-weight: 800;
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 600px) {
            body { padding: 12px; }
            .music-item { flex-wrap: wrap; gap: 10px; }
            .music-info { flex-wrap: wrap; }
            .music-bpm, .music-notes { font-size: 0.7rem; }
            .action-btn { width: 36px; height: 36px; }
            .modal-title-container { gap: 6px; }
            .font-btn, .scroll-btn, .speed-btn { padding: 6px 8px; }
            .vs-float-btn { width: 65px; height: 65px; font-size: 1.5rem; }
            .notes-float-btn { width: 50px; height: 50px; font-size: 1.5rem; bottom: 110px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="update-alert" class="update-alert" style="display: none;">
            <h3>üîÑ ATUALIZA√á√ÉO DISPON√çVEL!</h3>
            <p>H√° uma nova vers√£o do repert√≥rio dispon√≠vel.</p>
            <button class="btn" onclick="mostrarOpcoesUpdate()">
                üîÑ Fazer Update do Repert√≥rio
            </button>
        </div>
        
        <div id="install-prompt" class="install-prompt" style="display: none;">
            <strong>üí° Para melhor experi√™ncia:</strong><br>
            Adicione este app √† tela inicial do seu celular!
            <button class="btn btn-install" onclick="instalarApp()" style="margin-top: 10px;">
                üì± Instalar App Agora
            </button>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #00cc00;">
                ‚ö° Acesso r√°pido ‚ö° Sem internet ‚ö° Totalmente offline
            </div>
        </div>
        
        <div id="empty-state" class="empty-state">
            <h2>üéµ Bem-vindo ao Repert√≥rio BlueVox!</h2>
            <p>Gerencie seu repert√≥rio musical de forma pr√°tica e offline</p>
            
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center; margin-top: 20px;">
                <button class="btn btn-add" onclick="mostrarFormulario()">
                    ‚ûï Adicionar Primeira M√∫sica
                </button>
                
                <div style="color: #00aa00; margin: 10px 0;">ou</div>
                
                <div class="backup-options">
                    <div class="backup-option">
                        <div class="file-input-wrapper">
                            <button class="btn">
                                üì• Importar Backup
                            </button>
                            <input type="file" id="file-input-initial" accept=".xml" style="display: none;" onchange="iniciarImportacao(event)">
                        </div>
                    </div>
                    <div class="backup-option">
                        <button class="btn" onclick="mostrarImportacaoURL()">
                            üåê Importar de URL
                        </button>
                    </div>
                    <div class="backup-option">
                        <button class="btn" onclick="mostrarOpcoesUpdate()">
                            üîÑ Update do Repert√≥rio
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 25px; padding: 15px; background: #111; border-radius: 8px; border: 1px solid #00aa00;">
                <strong style="color: #00ff00;">‚ú® Dicas:</strong>
                <ul style="text-align: left; margin-top: 10px; color: #00cc00; padding-left: 20px;">
                    <li>Use <strong>[R]</strong> no in√≠cio das linhas para destaque em amarelo</li>
                    <li>Use <strong>|D|</strong> para cifras em laranja (ex: |G|, |C#m|, etc.)</li>
                    <li>Adicione √† tela inicial para acesso r√°pido</li>
                    <li>Todos os dados ficam salvos no seu navegador</li>
                    <li>Backup √∫nico em formato XML universal</li>
                    <li>Importe de arquivo local ou URL remota</li>
                </ul>
            </div>
        </div>
        
        <div id="music-list" class="music-list" style="display: none;"></div>
        
        <div id="setlist-container" class="setlist-container" style="display: none;">
            <div class="section-title">üéµ SETLIST DO SHOW</div>
            
            <div id="setlist-musicas" class="setlist-musicas"></div>
            
            <div class="setlist-controls">
                <button class="btn" onclick="musicaAnterior()">‚èÆÔ∏è Anterior</button>
                <button class="btn btn-add" onclick="proximaMusica()">‚è≠Ô∏è Pr√≥xima M√∫sica</button>
                <button class="btn btn-secondary" onclick="limparSetlist()">üóëÔ∏è Limpar Setlist</button>
            </div>
        </div>
        
        <div id="controls" class="controls" style="display: none;">
            <div class="controls-section">
                <button class="btn btn-add" onclick="mostrarFormulario()">
                    ‚ûï Adicionar M√∫sica
                </button>
            </div>

            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üëÅÔ∏è VISUALIZA√á√ÉO</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="backup-options">
                        <button class="btn" onclick="aplicarModoVisualizacao('tablet')" id="modo-tablet-btn">
                            üì± Modo Tablet
                        </button>
                        <button class="btn" onclick="aplicarModoVisualizacao('notebook')" id="modo-notebook-btn">
                            üíª Modo Notebook
                        </button>
                    </div>
                </div>
            </div>

            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üõ†Ô∏è UTILIT√ÅRIOS</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="backup-options">
                        <button class="btn" onclick="abrirTuner('bass')">
                            üé∏ Afinador de Baixo
                        </button>
                        <button class="btn" onclick="abrirTuner('guitar')">
                            üé∂ Afinador de Guitarra
                        </button>
                        <button class="btn" onclick="abrirMetronomeModal()">
                            ‚ô´ Metr√¥nomo Independente
                        </button>
                    </div>
                </div>
            </div>

            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üíæ BACKUP E DADOS</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="backup-options">
                        <button class="btn" onclick="exportarDados()">
                            üì§ Exportar Backup
                        </button>
                        
                        <div class="file-input-wrapper">
                            <button class="btn">
                                üì• Importar Backup
                            </button>
                            <input type="file" id="file-input" accept=".xml" style="display: none;" onchange="iniciarImportacao(event)">
                        </div>
                        
                        <button class="btn" onclick="mostrarImportacaoURL()">
                            üåê Importar de URL
                        </button>
                        
                        <button class="btn" onclick="mostrarOpcoesUpdate()">
                            üîÑ Update do Repert√≥rio
                        </button>
                    </div>
                </div>
            </div>

            <div class="expandable-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>‚öôÔ∏è CONFIGURA√á√ïES</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="backup-options">
                        <button class="btn" onclick="mostrarConfiguracoes()">
                            üé® Cores
                        </button>
                        
                        <button class="btn" onclick="resetarAplicativo()">
                            üóëÔ∏è Resetar App
                        </button>
                        
                        <button class="btn btn-install" onclick="instalarApp()" id="install-btn">
                            üì± Instalar App
                        </button>
                        
                        <button class="btn" onclick="mostrarAjuda()">
                            ‚ùì Ajuda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-info">
            <span id="music-count-footer" class="music-count-footer"></span>
            <span class="copyright">¬© 2025 BlueVox - Version 2.0 - By Jeferson</span>
        </div>
    </footer>

    <div id="music-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-container">
                    <h2 id="modal-title">T√çTULO DA M√öSICA</h2>
                    <span class="separator">-</span>
                    <div class="font-controls-header">
                        <button class="font-btn" onclick="ajustarFonte(-2)" title="Diminuir fonte">A-</button>
                        <button class="font-btn" onclick="ajustarFonte(0)" title="Fonte padr√£o">A</button>
                        <button class="font-btn" onclick="ajustarFonte(2)" title="Aumentar fonte">A+</button>
                    </div>
                    <div class="scroll-controls">
                        <button class="scroll-btn" id="scroll-toggle" onclick="toggleAutoScroll()" title="Auto Scroll">‚ñ∂Ô∏è Scroll</button>
                    </div>
                    <div class="scroll-speed-controls" id="speed-controls" style="display: none;">
                        <button class="speed-btn" onclick="changeScrollSpeed(-1)" title="Diminuir velocidade">-</button>
                        <span class="speed-display" id="current-speed-display">1</span>
                        <button class="speed-btn" onclick="changeScrollSpeed(1)" title="Aumentar velocidade">+</button>
                    </div>
                    <div class="metronome-controls">
                        <button class="metronome-btn" id="metronome-toggle" onclick="toggleMetronome()" title="Metr√¥nomo">‚ô´</button>
                    </div>
                    <div class="metronome-controls">
                        <button class="vs-btn" id="vs-header-btn" onclick="toggleVS()" title="Virtual Sound - Tocar faixa de √°udio">VS</button>
                    </div>
                    <div class="view-mode-controls">
                        <button class="view-mode-btn" id="view-mode-toggle" onclick="toggleViewMode()" title="Alternar modo de visualiza√ß√£o">üîÑ Visualiza√ß√£o</button>
                    </div>
                </div>
                <button class="close" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="lyrics-content" class="lyrics-content"></div>
            </div>
            <div class="modal-footer" id="setlist-navigation">
                <div class="navigation-controls">
                    <button class="nav-btn nav-btn-prev" onclick="musicaAnterior()" title="M√∫sica anterior">
                        ‚èÆÔ∏è
                    </button>
                    <button class="nav-btn nav-btn-next" onclick="proximaMusica()" title="Pr√≥xima m√∫sica">
                        ‚è≠Ô∏è
                    </button>
                </div>
            </div>
        </div>
        
        <button id="notes-float-btn" class="notes-float-btn" onclick="toggleNotesBubble()" title="Ver notas da m√∫sica">üìù</button>
        <button id="vs-float-btn" class="vs-float-btn" onclick="toggleVS()" title="Virtual Sound - Tocar/Parar faixa de √°udio">VS</button>
    </div>

    <div id="metronome-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ô´ METR√îNOMO INDEPENDENTE</h2>
                <button class="close" onclick="fecharMetronomeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="metronome-container">
                    <div class="bpm-controls">
                        <label for="bpm-input">BPM:</label>
                        <div class="bpm-input-group">
                            <button class="bpm-btn" onclick="alterarBPM(-5)">-5</button>
                            <button class="bpm-btn" onclick="alterarBPM(-1)">-1</button>
                            <input type="number" id="bpm-input" class="bpm-input" value="100" min="1" max="300">
                            <button class="bpm-btn" onclick="alterarBPM(1)">+1</button>
                            <button class="bpm-btn" onclick="alterarBPM(5)">+5</button>
                        </div>
                    </div>
                    
                    <div class="metronome-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="precount-checkbox">
                            <span class="checkmark"></span>
                            Ativar 4 batidas de pr√©-contagem
                        </label>
                    </div>
                    
                    <div class="metronome-display">
                        <div id="metronome-beat" class="metronome-beat">‚ô´</div>
                        <div id="metronome-status" class="metronome-status">Parado</div>
                    </div>
                    
                    <div class="metronome-actions">
                        <button id="metronome-play-btn" class="btn btn-add" onclick="toggleMetronomeIndependente()">‚ñ∂Ô∏è Iniciar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tuner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tuner-modal-title">üé∏ AFINADOR</h2>
                <button class="close" onclick="fecharTunerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tuner-container">
                    <div class="tuner-type-selector">
                        <button class="tuner-type-btn active" id="tuner-bass-btn" onclick="mudarTipoTuner('bass')">üé∏ Baixo 4 cordas</button>
                        <button class="tuner-type-btn" id="tuner-guitar-btn" onclick="mudarTipoTuner('guitar')">üé∂ Guitarra 6 cordas</button>
                    </div>
                    
                    <div id="tuner-bass" class="tuner-content">
                        <h3 class="tuner-title">AFINADOR DE BAIXO - 4 CORDAS</h3>
                        <div class="tuner-strings">
                            <button class="string-btn" onclick="tocarNota('E1', 'bass')">
                                <div class="string-note">E</div>
                                <div class="string-name">(41.20 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('A1', 'bass')">
                                <div class="string-note">A</div>
                                <div class="string-name">(55.00 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('D2', 'bass')">
                                <div class="string-note">D</div>
                                <div class="string-name">(73.42 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('G2', 'bass')">
                                <div class="string-note">G</div>
                                <div class="string-name">(98.00 Hz)</div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="tuner-guitar" class="tuner-content" style="display: none;">
                        <h3 class="tuner-title">AFINADOR DE GUITARRA - 6 CORDAS</h3>
                        <div class="tuner-strings">
                            <button class="string-btn" onclick="tocarNota('E2', 'guitar')">
                                <div class="string-note">E</div>
                                <div class="string-name">(82.41 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('A2', 'guitar')">
                                <div class="string-note">A</div>
                                <div class="string-name">(110.00 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('D3', 'guitar')">
                                <div class="string-note">D</div>
                                <div class="string-name">(146.83 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('G3', 'guitar')">
                                <div class="string-note">G</div>
                                <div class="string-name">(196.00 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('B3', 'guitar')">
                                <div class="string-note">B</div>
                                <div class="string-name">(246.94 Hz)</div>
                            </button>
                            <button class="string-btn" onclick="tocarNota('E4', 'guitar')">
                                <div class="string-note">E</div>
                                <div class="string-name">(329.63 Hz)</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="tuner-controls">
                        <button class="btn btn-secondary" onclick="pararTodasNotas()">‚èπÔ∏è Parar Todas as Notas</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: var(--cor-secundaria); font-size: 0.8rem;">
                        üí° Clique em uma corda para tocar a nota de refer√™ncia
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï ADICIONAR NOVA M√öSICA</h2>
                <button class="close" onclick="fecharAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-form" class="add-form" onsubmit="adicionarMusica(event)">
                    <div class="form-group">
                        <label for="nome-musica">NOME DA M√öSICA:</label>
                        <input type="text" id="nome-musica" class="form-input" required placeholder="Ex: REINO DOS RATOS">
                    </div>
                    
                    <div class="form-group">
                        <label for="bpm-musica">BPM (opcional):</label>
                        <input type="number" id="bpm-musica" class="form-input" placeholder="Ex: 150" min="1" max="300">
                    </div>
                    
                    <div class="form-group">
                        <label for="notas-musica">NOTAS (opcional):</label>
                        <textarea id="notas-musica" class="form-input" placeholder="Instru√ß√µes de execu√ß√£o, dicas, etc." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="letra-musica">LETRA DA M√öSICA:</label>
                        <textarea id="letra-musica" class="form-input form-textarea" required 
                                  placeholder="Cole aqui a letra completa...

Exemplo:
[R] ESTE √â O REINO DOS RATOS, √â PARAR OU SEGUIR |G|
[R] POR ENTRE RUAS E BECOS, UM LABIRINTO √Ä DESCOBRIR |D|
NA ESCURID√ÉO DO POR√ÉO, O SOL N√ÉO VAI ENTRAR |C|
CHEIRO DE MOFO E LIXO, SINTO TABACO NO AR |G|

üí° Use [R] no in√≠cio das linhas que devem aparecer em AMARELO
üí° Use |D|, |G|, |C#m| para cifras em LARANJA"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharAddModal()">Cancelar</button>
                        <button type="submit" class="btn btn-add">üíæ Salvar M√∫sica</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è EDITAR M√öSICA</h2>
                <button class="close" onclick="fecharEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-form" class="edit-form" onsubmit="editarMusica(event)">
                    <input type="hidden" id="edit-index">
                    <div class="form-group">
                        <label for="edit-nome-musica">NOME DA M√öSICA:</label>
                        <input type="text" id="edit-nome-musica" class="form-input" required placeholder="Ex: REINO DOS RATOS">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-bpm-musica">BPM (opcional):</label>
                        <input type="number" id="edit-bpm-musica" class="form-input" placeholder="Ex: 150" min="1" max="300">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notas-musica">NOTAS (opcional):</label>
                        <textarea id="edit-notas-musica" class="form-input" placeholder="Instru√ß√µes de execu√ß√£o, dicas, etc." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-letra-musica">LETRA DA M√öSICA:</label>
                        <textarea id="edit-letra-musica" class="form-input form-textarea" required 
                                  placeholder="Cole aqui a letra completa...

Exemplo:
[R] ESTE √â O REINO DOS RATOS, √â PARAR OU SEGUIR |G|
[R] POR ENTRE RUAS E BECOS, UM LABIRINTO √Ä DESCOBRIR |D|
NA ESCURID√ÉO DO POR√ÉO, O SOL N√ÉO VAI ENTRAR |C|
CHEIRO DE MOFO E LIXO, SINTO TABACO NO AR |G|

üí° Use [R] no in√≠cio das linhas que devem aparecer em AMARELO
üí° Use |D|, |G|, |C#m| para cifras em LARANJA"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharEditModal()">Cancelar</button>
                        <button type="submit" class="btn btn-add">üíæ Atualizar M√∫sica</button>
                        <button type="button" class="btn btn-delete" onclick="excluirMusicaEdicao()">üóëÔ∏è Excluir M√∫sica</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® CONFIGURA√á√ïES DE CORES</h2>
                <button class="close" onclick="fecharConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form class="config-form">
                    <div class="form-group">
                        <label>SELECIONE UM TEMA:</label>
                        <div class="color-options">
                            <div class="color-option active" data-theme="green" 
                                 style="background: #000000; color: #00ff00; border: 1px solid #00ff00;"
                                 onclick="aplicarTema('green')">
                                üü¢ Verde Neon
                            </div>
                            <div class="color-option" data-theme="blue"
                                 style="background: #000033; color: #0088ff; border: 1px solid #0088ff;"
                                 onclick="aplicarTema('blue')">
                                üîµ Azul Tech
                            </div>
                            <div class="color-option" data-theme="red"
                                 style="background: #330000; color: #ff4444; border: 1px solid #ff4444;"
                                 onclick="aplicarTema('red')">
                                üî¥ Vermelho
                            </div>
                            <div class="color-option" data-theme="purple"
                                 style="background: #1a001a; color: #cc00ff; border: 1px solid #cc00ff;"
                                 onclick="aplicarTema('purple')">
                                üü£ Roxo
                            </div>
                            <div class="color-option" data-theme="orange"
                                 style="background: #331900; color: #ff8800; border: 1px solid #ff8800;"
                                 onclick="aplicarTema('orange')">
                                üü† Laranja
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharConfigModal()">Fechar</button>
                        <button type="button" class="btn" onclick="resetarTema()">üîÑ Tema Padr√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="notes-modal" class="modal">
        <div class="notes-modal-content">
            <div class="notes-modal-header">
                <h2 id="notes-modal-title">üìù NOTAS DA M√öSICA</h2>
                <button class="close" onclick="fecharNotesModal()">&times;</button>
            </div>
            <div class="notes-modal-body">
                <div id="notes-content" class="notes-content"></div>
            </div>
            <div class="notes-modal-footer">
                <button class="btn btn-secondary" onclick="fecharNotesModal()">Fechar</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• OP√á√ïES DE IMPORTAR</h2>
                <button class="close" onclick="fecharImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
                    <div class="form-group">
                        <label>ENCONTRADAS <span id="import-count">0</span> M√öSICA(S) NO BACKUP</label>
                        <p style="color: var(--cor-secundaria); margin-bottom: 20px;">
                            Selecione como deseja importar as m√∫sicas:
                        </p>
                        
                        <div class="import-options">
                            <div class="import-option" onclick="selecionarOpcaoImport('substituir')" id="option-substituir">
                                <h3>üîÑ SUBSTITUIR TUDO</h3>
                                <p>Remove todas as m√∫sicas atuais e importa apenas as do backup</p>
                            </div>
                            
                            <div class="import-option" onclick="selecionarOpcaoImport('adicionar')" id="option-adicionar">
                                <h3>‚ûï ADICIONAR NOVAS</h3>
                                <p>Mant√©m as m√∫sicas atuais e adiciona apenas as que n√£o existem</p>
                            </div>
                            
                            <div class="import-option" onclick="selecionarOpcaoImport('mesclar')" id="option-mesclar">
                                <h3>üîÑ MESCLAR TUDO</h3>
                                <p>Combina todas as m√∫sicas, atualizando as existentes e adicionando novas</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharImportModal()">Cancelar</button>
                        <button type="button" class="btn btn-add" onclick="confirmarImportacao()" id="confirm-import-btn" disabled>
                            üíæ Confirmar Importa√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="import-url-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üåê IMPORTAR DE URL</h2>
                <button class="close" onclick="fecharImportURLModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form class="config-form" onsubmit="importarDeURL(event)">
                    <div class="form-group">
                        <label for="url-xml">URL DO ARQUIVO XML:</label>
                        <input type="url" id="url-xml" class="form-input" required 
                               placeholder="Ex: http://teste.com.br/musicas.xml"
                               pattern="https?://.+" title="Digite uma URL v√°lida come√ßando com http:// ou https://">
                        <p style="color: var(--cor-secundaria); margin-top: 8px; font-size: 0.8rem;">
                            üí° A URL deve apontar para um arquivo XML v√°lido do Repert√≥rio BlueVox
                        </p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharImportURLModal()">Cancelar</button>
                        <button type="submit" class="btn btn-add">üì• Importar da URL</button>
                    </div>
                </form>
                
                <div id="url-loading" style="display: none; text-align: center; padding: 20px;">
                    <div style="color: var(--cor-primaria); margin-bottom: 10px;">‚è≥ Carregando dados da URL...</div>
                    <div style="color: var(--cor-secundaria); font-size: 0.8rem;">
                        Aguarde enquanto buscamos o arquivo XML
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ UPDATE DO REPERT√ìRIO</h2>
                <button class="close" onclick="fecharUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
                    <div class="form-group">
                        <label>ENCONTRADAS <span id="update-count">0</span> M√öSICA(S) NO REPERT√ìRIO ONLINE</label>
                        <p style="color: var(--cor-secundaria); margin-bottom: 20px;">
                            Selecione como deseja atualizar o repert√≥rio:
                        </p>
                        
                        <div class="import-options">
                            <div class="import-option" onclick="selecionarOpcaoUpdate('substituir')" id="update-option-substituir">
                                <h3>üîÑ SUBSTITUIR TUDO</h3>
                                <p>Remove todas as m√∫sicas atuais e importa apenas as do repert√≥rio online</p>
                            </div>
                            
                            <div class="import-option" onclick="selecionarOpcaoUpdate('mesclar')" id="update-option-mesclar">
                                <h3>üîÑ MESCLAR TUDO</h3>
                                <p>Combina todas as m√∫sicas, atualizando as existentes e adicionando novas</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharUpdateModal()">Cancelar</button>
                        <button type="button" class="btn btn-add" onclick="confirmarUpdate()" id="confirm-update-btn" disabled>
                            üíæ Confirmar Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO
        let musicas = [];
        let deferredPrompt = null;
        let tamanhoFonteBase = 14;
        let autoScrollAtivo = false;
        let scrollInterval = null;
        let scrollSpeed = 1;
        
        // Vari√°veis para controle de importa√ß√£o
        let dadosImportacao = null;
        let opcaoImportSelecionada = null;
        let importacaoURLEmAndamento = false;

        // Vari√°veis para o setlist
        let setlist = [];
        let indiceMusicaAtual = -1;

        // Vari√°veis para modos de visualiza√ß√£o
        let modoVisualizacaoAtual = 'retrato';
        let modoDispositivo = 'tablet';

        // Vari√°veis do metr√¥nomo
        let metronomeAtivo = false;
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let currentBPM = 120;
        let indiceMusicaAberta = -1;

        // Vari√°veis para os afinadores
        let tunerAudioContext = null;
        let tunerOscillator = null;
        let notaAtual = null;
        let tipoTunerAtual = 'bass';

        // Vari√°veis do metr√¥nomo independente
        let metronomeBPM = 100;
        let metronomeRunning = false;
        let metronomeIntervalIndependente = null;
        let metronomeAudioContextIndependente = null;
        let metronomePrecount = false;
        let metronomePrecountCount = 0;
        let metronomePrecountInterval = null;

        // ===== NOVAS VARI√ÅVEIS PARA O VS E NOTAS =====
        let vsAudio = null;
        let vsAtivo = false;
        let musicaVSAberta = null;
        let vsCountdownInterval = null;
        let vsCountdown = 0;
        let vsAguardandoArquivo = false;
        
        // Vari√°veis para o bal√£o de notas
        let notesBubbleAberto = false;
        // ===== FIM DAS VARI√ÅVEIS =====

        // URL do repert√≥rio online
        const REPERTORIO_URL = "https://jecwb.github.io/bluevox/repertorio.xml";

        // Frequ√™ncias das notas para os afinadores
        const frequencias = {
            'bass': {
                'E1': 41.20,
                'A1': 55.00,
                'D2': 73.42,
                'G2': 98.00
            },
            'guitar': {
                'E2': 82.41,
                'A2': 110.00,
                'D3': 146.83,
                'G3': 196.00,
                'B3': 246.94,
                'E4': 329.63
            }
        };

        const temas = {
            green: {
                primaria: '#00ff00',
                secundaria: '#00aa00',
                fundo: '#000000',
                texto: '#00ff00',
                destaque: '#ffff00',
                botao: '#003300',
                hover: '#004400'
            },
            blue: {
                primaria: '#0088ff',
                secundaria: '#0066cc',
                fundo: '#000033',
                texto: '#0088ff',
                destaque: '#00ffff',
                botao: '#003366',
                hover: '#004477'
            },
            red: {
                primaria: '#ff4444',
                secundaria: '#cc0000',
                fundo: '#330000',
                texto: '#ff4444',
                destaque: '#ff8888',
                botao: '#660000',
                hover: '#770000'
            },
            purple: {
                primaria: '#cc00ff',
                secundaria: '#9900cc',
                fundo: '#1a001a',
                texto: '#cc00ff',
                destaque: '#ff88ff',
                botao: '#330033',
                hover: '#440044'
            },
            orange: {
                primaria: '#ff8800',
                secundaria: '#cc6600',
                fundo: '#331900',
                texto: '#ff8800',
                destaque: '#ffcc00',
                botao: '#663300',
                hover: '#774400'
            }
        };

        // INICIAR APLICA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéµ Repert√≥rio BlueVox iniciado');
            
            // Configurar PWA
            configurarPWA();
            
            // Carregar configura√ß√µes salvas
            carregarConfiguracoes();
            
            // Carregar m√∫sicas salvas
            const musicasSalvas = localStorage.getItem('catalogoMusicas');
            if (musicasSalvas) {
                try {
                    musicas = JSON.parse(musicasSalvas);
                    if (musicas.length > 0) {
                        mostrarInterfaceComMusicas();
                    }
                } catch (e) {
                    console.error('Erro ao carregar m√∫sicas:', e);
                    musicas = [];
                }
            }

            // Carregar setlist
            const setlistSalvo = localStorage.getItem('setlistRepertorio');
            if (setlistSalvo) {
                setlist = JSON.parse(setlistSalvo);
                exibirSetlist();
            }

            // Carregar √≠ndice atual
            const indiceSalvo = localStorage.getItem('indiceMusicaAtual');
            if (indiceSalvo !== null) {
                indiceMusicaAtual = parseInt(indiceSalvo);
            }

            // Carregar modo de visualiza√ß√£o
            const modoVisualizacaoSalvo = localStorage.getItem('modoVisualizacao');
            if (modoVisualizacaoSalvo) {
                modoVisualizacaoAtual = modoVisualizacaoSalvo;
            }

            // Carregar modo de dispositivo
            const modoDispositivoSalvo = localStorage.getItem('modoDispositivo');
            if (modoDispositivoSalvo) {
                modoDispositivo = modoDispositivoSalvo;
                atualizarBotoesModoDispositivo();
            }

            // Configurar eventos GLOBAIS (s√≥ uma vez)
            configurarEventosGlobais();
            
            // Verificar se h√° atualiza√ß√µes dispon√≠veis
            verificarAtualizacoes();
            
            // Atualizar contador no rodap√©
            atualizarContadorRodape();

            // Configurar eventos do metr√¥nomo independente
            const bpmInput = document.getElementById('bpm-input');
            if (bpmInput) {
                bpmInput.addEventListener('change', function() {
                    let valor = parseInt(this.value);
                    if (isNaN(valor) || valor < 1) {
                        valor = 1;
                    } else if (valor > 300) {
                        valor = 300;
                    }
                    metronomeBPM = valor;
                    this.value = metronomeBPM;
                    // Se o metr√¥nomo estiver rodando, reiniciar com o novo BPM
                    if (metronomeRunning) {
                        pararMetronomeIndependente();
                        iniciarMetronomeIndependente();
                    }
                });
            }
        });

        // FUN√á√ÉO PARA ALTERNAR SE√á√ïES EXPANS√çVEIS
        function toggleSection(header) {
            const section = header.parentElement;
            const content = section.querySelector('.section-content');
            const arrow = header.querySelector('.arrow');
            
            // Alternar classes
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            
            // Anima√ß√£o da seta
            if (content.classList.contains('expanded')) {
                arrow.textContent = '‚ñ≤';
            } else {
                arrow.textContent = '‚ñº';
            }
        }

        // CONFIGURAR PWA - COM BOT√ÉO FIXO
        function configurarPWA() {
            const isGitHubPages = window.location.hostname === 'jecwb.github.io';
            const repoPath = '/bluevox/';
            
            // Verificar se j√° est√° instalado (modo standalone)
            const isInStandaloneMode = () => 
                (window.matchMedia('(display-mode: standalone)').matches) ||
                (window.navigator.standalone) ||
                (document.referrer.includes('android-app://'));
            
            if (isInStandaloneMode()) {
                console.log('üì± Executando em modo PWA - ocultando bot√£o de instala√ß√£o');
                // Ocultar bot√£o de instala√ß√£o se j√° estiver instalado
                const installBtn = document.getElementById('install-btn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
                document.getElementById('install-prompt').style.display = 'none';
                
                // Se estiver no GitHub Pages e em modo PWA, verificar se estamos no caminho correto
                if (isGitHubPages && !window.location.pathname.startsWith(repoPath)) {
                    console.log('üîÑ Redirecionando para o caminho correto do GitHub Pages');
                    window.location.href = repoPath;
                    return;
                }
            } else {
                console.log('üåê Executando no navegador - habilitando instala√ß√£o PWA');
                
                // Configurar evento para capturar o prompt de instala√ß√£o
                window.addEventListener('beforeinstallprompt', (e) => {
                    console.log('üì≤ Evento beforeinstallprompt disparado');
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // Mostrar prompt autom√°tico ap√≥s um tempo
                    setTimeout(() => {
                        if (deferredPrompt && !localStorage.getItem('pwaDismissed')) {
                            console.log('üëÜ Mostrando prompt de instala√ß√£o autom√°tico');
                            document.getElementById('install-prompt').style.display = 'block';
                        }
                    }, 3000);
                });
            }

            // Detectar se o app foi instalado
            window.addEventListener('appinstalled', () => {
                console.log('‚úÖ App instalado com sucesso');
                localStorage.setItem('pwaInstalado', 'true');
                document.getElementById('install-prompt').style.display = 'none';
                
                // Ocultar bot√£o de instala√ß√£o
                const installBtn = document.getElementById('install-btn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
                
                deferredPrompt = null;
                
                // Se for GitHub Pages, garantir que estamos no caminho correto
                if (isGitHubPages && !window.location.pathname.startsWith(repoPath)) {
                    setTimeout(() => {
                        window.location.href = repoPath;
                    }, 1000);
                }
            });

            // Verificar crit√©rios de instalabilidade
            verificarInstalabilidade();
        }

        function verificarInstalabilidade() {
            // Crit√©rios b√°sicos para PWA instal√°vel
            const hasManifest = document.querySelector('link[rel="manifest"]') !== null;
            const hasIcons = document.querySelector('link[rel="icon"][sizes="192x192"]') !== null ||
                            document.querySelector('link[rel="icon"][sizes="512x512"]') !== null;
            const isHTTPS = window.location.protocol === 'https:';
            
            console.log('üîç Crit√©rios PWA:', {
                hasManifest,
                hasIcons,
                isHTTPS,
                isGitHubPages: window.location.hostname === 'jecwb.github.io'
            });

            if (hasManifest && hasIcons && isHTTPS) {
                console.log('‚úÖ App atende aos crit√©rios m√≠nimos para instala√ß√£o PWA');
            }
        }

        function instalarApp() {
            if (deferredPrompt) {
                console.log('üöÄ Iniciando instala√ß√£o PWA via bot√£o...');
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Usu√°rio aceitou a instala√ß√£o PWA');
                        localStorage.setItem('pwaInstalado', 'true');
                        document.getElementById('install-prompt').style.display = 'none';
                        
                        // Ocultar bot√£o de instala√ß√£o
                        const installBtn = document.getElementById('install-btn');
                        if (installBtn) {
                            installBtn.style.display = 'none';
                        }
                        
                        // Se for GitHub Pages, redirecionar para o caminho correto ap√≥s instala√ß√£o
                        if (window.location.hostname === 'jecwb.github.io' && !window.location.pathname.startsWith('/bluevox/')) {
                            setTimeout(() => {
                                window.location.href = '/bluevox/';
                            }, 1000);
                        }
                    } else {
                        console.log('‚ùå Usu√°rio recusou a instala√ß√£o PWA');
                        localStorage.setItem('pwaDismissed', 'true');
                    }
                    deferredPrompt = null;
                });
            } else {
                console.log('‚ÑπÔ∏è Prompt de instala√ß√£o n√£o dispon√≠vel, mostrando instru√ß√µes manuais');
                // Fallback para quando n√£o h√° prompt de instala√ß√£o
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                let instructions = '';
                
                if (isIOS) {
                    instructions = 'Para instalar no iPhone/iPad:\n\n1. Toque no √≠cone de compartilhar (üì§)\n2. Role para baixo e toque em "Adicionar √† Tela de In√≠cio"\n3. Toque em "Adicionar" no canto superior direito';
                } else if (isAndroid) {
                    instructions = 'Para instalar no Android:\n\n1. Toque no menu (‚ãØ) no canto superior direito\n2. Toque em "Adicionar √† tela inicial"\n3. Toque em "Adicionar" para confirmar';
                } else {
                    instructions = 'Para instalar o app:\n\n‚Ä¢ Chrome: Menu ‚Üí "Instalar Repert√≥rio BlueVox"\n‚Ä¢ Safari: Compartilhar ‚Üí "Adicionar √† tela de in√≠cio"\n‚Ä¢ Firefox: Menu ‚Üí "Instalar site"';
                }
                
                alert('üì± ' + instructions);
            }
        }

        // CONFIGURA√á√ïES DE CORES
        function carregarConfiguracoes() {
            const temaSalvo = localStorage.getItem('temaRepertorio') || 'green';
            aplicarTema(temaSalvo);
        }

        function mostrarConfiguracoes() {
            document.getElementById('config-modal').style.display = 'block';
            const temaAtual = localStorage.getItem('temaRepertorio') || 'green';
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === temaAtual) {
                    option.classList.add('active');
                }
            });
        }

        function fecharConfigModal() {
            document.getElementById('config-modal').style.display = 'none';
        }

        function aplicarTema(tema) {
            const cores = temas[tema];
            const root = document.documentElement;
            
            root.style.setProperty('--cor-primaria', cores.primaria);
            root.style.setProperty('--cor-secundaria', cores.secundaria);
            root.style.setProperty('--cor-fundo', cores.fundo);
            root.style.setProperty('--cor-texto', cores.texto);
            root.style.setProperty('--cor-destaque', cores.destaque);
            root.style.setProperty('--cor-botao', cores.botao);
            root.style.setProperty('--cor-hover', cores.hover);
            
            document.querySelector('meta[name="theme-color"]').setAttribute('content', cores.primaria);
            localStorage.setItem('temaRepertorio', tema);
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-theme="${tema}"]`).classList.add('active');
        }

        function resetarTema() {
            aplicarTema('green');
        }

        // CONTROLES DE FONTE E SCROLL - CORRIGIDO
        function ajustarFonte(mudanca) {
            const elemento = document.getElementById('lyrics-content');
            if (!elemento) return;
            
            let tamanhoAtual = parseFloat(getComputedStyle(elemento).fontSize);
            
            if (mudanca === 0) {
                // Reset para tamanho base baseado no modo atual
                if (modoVisualizacaoAtual === 'paisagem') {
                    elemento.style.fontSize = '22px';
                    tamanhoFonteBase = 22;
                } else {
                    elemento.style.fontSize = '14px';
                    tamanhoFonteBase = 14;
                }
            } else {
                const novoTamanho = Math.max(10, Math.min(40, tamanhoAtual + mudanca));
                elemento.style.fontSize = novoTamanho + 'px';
                tamanhoFonteBase = novoTamanho;
                
                // Se estiver aumentando muito, ajustar automaticamente
                if (novoTamanho > 30) {
                    ajustarFonteAuto();
                }
            }
        }

        function ajustarFonteAuto() {
            const elemento = document.getElementById('lyrics-content');
            if (!elemento) return;
            
            const texto = elemento.textContent;
            const linhas = texto.split('\n');
            const linhaMaisLonga = linhas.reduce((maisLonga, linha) => 
                linha.length > maisLonga.length ? linha : maisLonga, '');
            
            const larguraDisponivel = elemento.clientWidth - 40;
            const tamanhoIdeal = Math.max(12, Math.min(24, Math.floor(larguraDisponivel / (linhaMaisLonga.length * 0.6))));
            
            elemento.style.fontSize = tamanhoIdeal + 'px';
            tamanhoFonteBase = tamanhoIdeal;
        }

        function toggleAutoScroll() {
            autoScrollAtivo = !autoScrollAtivo;
            const botao = document.getElementById('scroll-toggle');
            const controlesVelocidade = document.getElementById('speed-controls');
            
            if (!botao) return;
            
            if (autoScrollAtivo) {
                botao.classList.add('active');
                botao.innerHTML = '‚è≥ Scroll';
                controlesVelocidade.style.display = 'flex';
                
                // Atualizar o display da velocidade
                atualizarDisplayVelocidade();
                
                // Mostrar mensagem informando sobre o delay
                const lyricsContent = document.getElementById('lyrics-content');
                if (lyricsContent) {
                    const mensagemDelay = document.createElement('div');
                    mensagemDelay.style.cssText = 'position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #00ff00; padding: 10px; border-radius: 5px; border: 1px solid #00ff00; z-index: 1000;';
                    mensagemDelay.innerHTML = '‚è≥ Auto scroll iniciar√° em 10 segundos...';
                    mensagemDelay.id = 'delay-message';
                    document.querySelector('.modal-content').appendChild(mensagemDelay);
                    
                    // Remover mensagem ap√≥s 3 segundos
                    setTimeout(() => {
                        const msg = document.getElementById('delay-message');
                        if (msg) msg.remove();
                    }, 3000);
                }
                
                iniciarAutoScroll();
            } else {
                botao.classList.remove('active');
                botao.innerHTML = '‚ñ∂Ô∏è Scroll';
                controlesVelocidade.style.display = 'none';
                pararAutoScroll();
                
                // Remover mensagem de delay se existir
                const mensagemDelay = document.getElementById('delay-message');
                if (mensagemDelay) mensagemDelay.remove();
            }
        }

        // NOVA FUN√á√ÉO PARA MUDAR VELOCIDADE COM BOT√ïES +/-
        function changeScrollSpeed(change) {
            const newSpeed = Math.max(1, Math.min(7, scrollSpeed + change));
            setScrollSpeed(newSpeed);
        }

        function setScrollSpeed(velocidade) {
            scrollSpeed = velocidade;
            
            // Atualizar o display da velocidade
            atualizarDisplayVelocidade();
            
            // Reiniciar scroll se estiver ativo
            if (autoScrollAtivo) {
                pararAutoScroll();
                iniciarAutoScroll();
            }
        }

        function atualizarDisplayVelocidade() {
            const speedDisplay = document.getElementById('current-speed-display');
            if (speedDisplay) {
                speedDisplay.textContent = scrollSpeed;
            }
        }

        function iniciarAutoScroll() {
            const lyricsContent = document.getElementById('lyrics-content');
            const modalBody = document.querySelector('.modal-body');
            
            if (!lyricsContent || !modalBody) return;
            
            // Verificar se j√° chegou ao final
            if (modalBody.scrollTop >= lyricsContent.scrollHeight - modalBody.clientHeight) {
                // Se estiver no final, voltar para o topo
                modalBody.scrollTop = 0;
            }
            
            // VELOCIDADES MAIS LENTAS E GRADATIVAS:
            const velocidades = {
                1: 0.2,   // Muito muito lento
                2: 0.4,   // Muito lento
                3: 0.8,   // Lento
                4: 1.2,   // Normal-lento
                5: 1.8,   // Normal
                6: 2.5,   // R√°pido
                7: 3.5    // Muito r√°pido
            };
            
            pararAutoScroll(); // Garantir que n√£o h√° intervalos duplicados
            
            // AGUARDAR 10 SEGUNDOS ANTES DE INICIAR O SCROLL
            setTimeout(() => {
                scrollInterval = setInterval(() => {
                    const currentScroll = modalBody.scrollTop;
                    const maxScroll = lyricsContent.scrollHeight - modalBody.clientHeight;
                    
                    if (currentScroll >= maxScroll) {
                        // Chegou ao final - parar auto scroll
                        pararAutoScroll();
                        autoScrollAtivo = false;
                        const scrollToggle = document.getElementById('scroll-toggle');
                        if (scrollToggle) {
                            scrollToggle.classList.remove('active');
                            scrollToggle.innerHTML = '‚ñ∂Ô∏è Scroll';
                        }
                        const speedControls = document.getElementById('speed-controls');
                        if (speedControls) speedControls.style.display = 'none';
                        return;
                    }
                    
                    // Aplicar scroll suave
                    modalBody.scrollTop += velocidades[scrollSpeed];
                    
                }, 16); // ‚âà 60fps
            }, 10000); // 10 segundos de delay
        }

        function pararAutoScroll() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        // FUN√á√ïES DO METR√îNOMO
        function toggleMetronome() {
            const botao = document.getElementById('metronome-toggle');
            const musicaAtual = musicas[indiceMusicaAberta];
            
            if (!musicaAtual || !musicaAtual.bpm) {
                alert('‚ùå Esta m√∫sica n√£o tem BPM definido!');
                return;
            }

            if (metronomeAtivo) {
                pararMetronome();
                botao.classList.remove('active');
            } else {
                currentBPM = parseInt(musicaAtual.bpm);
                iniciarMetronome();
                botao.classList.add('active');
            }
        }

        function iniciarMetronome() {
            if (metronomeAtivo) return;
            
            metronomeAtivo = true;
            const intervalo = 60000 / currentBPM; // ms por batida
            
            // Criar contexto de √°udio se n√£o existir
            if (!metronomeAudioContext) {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            let contador = 0;
            
            metronomeInterval = setInterval(() => {
                playMetronomeSound(contador === 0); // Destaque na primeira batida
                contador = (contador + 1) % 4; // Padr√£o 4/4
            }, intervalo);
        }

        function playMetronomeSound(accent) {
            if (!metronomeAudioContext) return;
            
            const oscillator = metronomeAudioContext.createOscillator();
            const gainNode = metronomeAudioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(metronomeAudioContext.destination);
            
            // Configurar o som
            oscillator.frequency.value = accent ? 800 : 400; // Hz - mais agudo na primeira batida
            oscillator.type = 'square';
            
            // Configurar o volume
            gainNode.gain.value = accent ? 0.3 : 0.2;
            gainNode.gain.exponentialRampToValueAtTime(0.001, metronomeAudioContext.currentTime + 0.1);
            
            // Tocar o som
            oscillator.start();
            oscillator.stop(metronomeAudioContext.currentTime + 0.1);
        }

        function pararMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            metronomeAtivo = false;
        }

        // FUN√á√ïES DO METR√îNOMO INDEPENDENTE
        function abrirMetronomeModal() {
            document.getElementById('metronome-modal').style.display = 'block';
            // Parar o metr√¥nomo se estiver rodando
            if (metronomeRunning) {
                pararMetronomeIndependente();
            }
            // Atualizar o valor do BPM no input
            document.getElementById('bpm-input').value = metronomeBPM;
            document.getElementById('precount-checkbox').checked = metronomePrecount;
            atualizarDisplayMetronome();
        }

        function fecharMetronomeModal() {
            document.getElementById('metronome-modal').style.display = 'none';
            // Parar o metr√¥nomo ao fechar
            if (metronomeRunning) {
                pararMetronomeIndependente();
            }
        }

        function alterarBPM(valor) {
            metronomeBPM = Math.max(1, Math.min(300, metronomeBPM + valor));
            document.getElementById('bpm-input').value = metronomeBPM;
            // Se o metr√¥nomo estiver rodando, reiniciar com o novo BPM
            if (metronomeRunning) {
                pararMetronomeIndependente();
                iniciarMetronomeIndependente();
            }
        }

        function toggleMetronomeIndependente() {
            if (metronomeRunning) {
                pararMetronomeIndependente();
            } else {
                iniciarMetronomeIndependente();
            }
        }

        function iniciarMetronomeIndependente() {
            if (metronomeRunning) return;
            
            metronomeRunning = true;
            metronomePrecount = document.getElementById('precount-checkbox').checked;
            metronomePrecountCount = 0;
            
            // Atualizar interface
            document.getElementById('metronome-play-btn').textContent = '‚èπÔ∏è Parar';
            document.getElementById('metronome-status').textContent = 'Iniciando...';
            
            // Verificar se h√° pr√©-contagem
            if (metronomePrecount) {
                iniciarPrecontagem();
            } else {
                iniciarBatidaMetronomo();
            }
        }

        function pararMetronomeIndependente() {
            metronomeRunning = false;
            
            // Parar intervalos
            if (metronomeIntervalIndependente) {
                clearInterval(metronomeIntervalIndependente);
                metronomeIntervalIndependente = null;
            }
            if (metronomePrecountInterval) {
                clearInterval(metronomePrecountInterval);
                metronomePrecountInterval = null;
            }
            
            // Atualizar interface
            document.getElementById('metronome-play-btn').textContent = '‚ñ∂Ô∏è Iniciar';
            document.getElementById('metronome-status').textContent = 'Parado';
            document.getElementById('metronome-beat').classList.remove('active');
        }

        function iniciarPrecontagem() {
            let count = 4;
            document.getElementById('metronome-status').textContent = `Pr√©-contagem: ${count}`;
            
            // Tocar a pr√©-contagem
            tocarSomMetronomoIndependente(600); // Som mais agudo para pr√©-contagem
            
            metronomePrecountInterval = setInterval(() => {
                count--;
                if (count <= 0) {
                    clearInterval(metronomePrecountInterval);
                    metronomePrecountInterval = null;
                    iniciarBatidaMetronomo();
                    return;
                }
                document.getElementById('metronome-status').textContent = `Pr√©-contagem: ${count}`;
                tocarSomMetronomoIndependente(600);
            }, 60000 / metronomeBPM);
        }

        function iniciarBatidaMetronomo() {
            let beatCount = 0;
            document.getElementById('metronome-status').textContent = 'Tocando...';
            
            // Tocar a primeira batida imediatamente
            tocarSomMetronomoIndependente(beatCount === 0 ? 800 : 400);
            document.getElementById('metronome-beat').classList.add('active');
            setTimeout(() => {
                document.getElementById('metronome-beat').classList.remove('active');
            }, 100);
            
            metronomeIntervalIndependente = setInterval(() => {
                beatCount = (beatCount + 1) % 4;
                
                // Tocar o som
                tocarSomMetronomoIndependente(beatCount === 0 ? 800 : 400);
                
                // Atualizar visual
                document.getElementById('metronome-beat').classList.add('active');
                setTimeout(() => {
                    document.getElementById('metronome-beat').classList.remove('active');
                }, 100);
                
            }, 60000 / metronomeBPM);
        }

        function tocarSomMetronomoIndependente(frequencia) {
            if (!metronomeAudioContextIndependente) {
                metronomeAudioContextIndependente = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = metronomeAudioContextIndependente.createOscillator();
            const gainNode = metronomeAudioContextIndependente.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(metronomeAudioContextIndependente.destination);
            
            oscillator.frequency.value = frequencia;
            oscillator.type = 'square';
            
            gainNode.gain.value = 0.3;
            gainNode.gain.exponentialRampToValueAtTime(0.001, metronomeAudioContextIndependente.currentTime + 0.1);
            
            oscillator.start();
            oscillator.stop(metronomeAudioContextIndependente.currentTime + 0.1);
        }

        function atualizarDisplayMetronome() {
            // Atualiza o display do metr√¥nomo (caso necess√°rio)
        }

        // ===== FUN√á√ïES PARA O BOT√ÉO DE NOTAS =====
        function toggleNotesBubble() {
            if (!musicaVSAberta) return;
            
            if (notesBubbleAberto) {
                fecharNotesBubble();
            } else {
                abrirNotesBubble();
            }
        }
        
        function abrirNotesBubble() {
            if (!musicaVSAberta) return;
            
            // Fechar bubble anterior se existir
            fecharNotesBubble();
            
            const musica = musicaVSAberta;
            const notas = musica.notas || "üìù Nenhuma nota cadastrada para esta m√∫sica.";
            
            // Criar elemento do bal√£o
            const bubble = document.createElement('div');
            bubble.className = 'notes-bubble';
            bubble.id = 'notes-bubble';
            
            // Formatar notas (escapar HTML e converter quebras de linha)
            const notasFormatadas = notas
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '<br>');
            
            bubble.innerHTML = `
                <div class="notes-bubble-header">
                    <span>üìù NOTAS</span>
                    <span class="notes-bubble-close" onclick="fecharNotesBubble()">‚úï</span>
                </div>
                <div class="notes-bubble-content">
                    ${notasFormatadas}
                </div>
            `;
            
            document.body.appendChild(bubble);
            notesBubbleAberto = true;
            
            // Atualizar visual do bot√£o
            const notesBtn = document.getElementById('notes-float-btn');
            if (musica.notas) {
                notesBtn.classList.add('has-notes');
                notesBtn.classList.remove('no-notes');
            } else {
                notesBtn.classList.add('no-notes');
                notesBtn.classList.remove('has-notes');
            }
            
            // Fechar ao clicar fora (com delay para n√£o fechar imediatamente ao clicar no bot√£o)
            setTimeout(() => {
                document.addEventListener('click', fecharNotesBubbleFora);
            }, 100);
        }
        
        function fecharNotesBubble() {
            const bubble = document.getElementById('notes-bubble');
            if (bubble) {
                bubble.remove();
            }
            notesBubbleAberto = false;
            document.removeEventListener('click', fecharNotesBubbleFora);
        }
        
        function fecharNotesBubbleFora(e) {
            const bubble = document.getElementById('notes-bubble');
            const notesBtn = document.getElementById('notes-float-btn');
            
            // Se clicou no bot√£o de notas, n√£o fechar (o toggle cuida disso)
            if (notesBtn && notesBtn.contains(e.target)) {
                return;
            }
            
            // Se clicou fora do bal√£o, fechar
            if (bubble && !bubble.contains(e.target)) {
                fecharNotesBubble();
            }
        }
        
        function atualizarNotesButton() {
            const notesBtn = document.getElementById('notes-float-btn');
            if (!notesBtn) return;
            
            if (musicaVSAberta && musicaVSAberta.notas) {
                notesBtn.classList.add('has-notes');
                notesBtn.classList.remove('no-notes');
                notesBtn.title = 'Ver notas da m√∫sica';
            } else {
                notesBtn.classList.add('no-notes');
                notesBtn.classList.remove('has-notes');
                notesBtn.title = 'Nenhuma nota cadastrada';
            }
        }
        // ===== FIM DAS FUN√á√ïES DE NOTAS =====

        // ===== FUN√á√ïES PARA O VS =====
        function formatarNomeArquivoVS(nomeMusica) {
            // Converter para min√∫sculas e remover acentos
            let nomeFormatado = nomeMusica.toLowerCase();
            
            // Substituir acentos
            nomeFormatado = nomeFormatado.replace(/[√°√†√£√¢√§]/g, 'a')
                                         .replace(/[√©√®√™√´]/g, 'e')
                                         .replace(/[√≠√¨√Æ√Ø]/g, 'i')
                                         .replace(/[√≥√≤√µ√¥√∂]/g, 'o')
                                         .replace(/[√∫√π√ª√º]/g, 'u')
                                         .replace(/√ß/g, 'c')
                                         .replace(/√±/g, 'n');
            
            // Substituir caracteres especiais por h√≠fen
            nomeFormatado = nomeFormatado.replace(/[^\w\s]/g, '');
            
            // Substituir espa√ßos por h√≠fen
            nomeFormatado = nomeFormatado.replace(/\s+/g, '-');
            
            // Remover h√≠fens duplicados
            nomeFormatado = nomeFormatado.replace(/-+/g, '-');
            
            // Remover h√≠fens no in√≠cio e no final
            nomeFormatado = nomeFormatado.replace(/^-+|-+$/g, '');
            
            return nomeFormatado;
        }

        function toggleVS() {
            if (!musicaVSAberta) return;
            
            if (vsAtivo) {
                // Se est√° tocando, parar imediatamente
                pararVS();
            } else if (vsCountdownInterval) {
                // Se est√° em contagem regressiva, cancelar
                cancelarCountdownVS();
                pararVS();
            } else {
                // Iniciar contagem regressiva de 5 segundos
                iniciarCountdownVS();
            }
        }

        function iniciarCountdownVS() {
            vsCountdown = 5;
            vsAguardandoArquivo = false;
            
            // Atualizar interface para modo countdown
            const vsFloatBtn = document.getElementById('vs-float-btn');
            const vsHeaderBtn = document.getElementById('vs-header-btn');
            
            vsFloatBtn.classList.add('countdown');
            vsFloatBtn.innerHTML = vsCountdown;
            
            if (vsHeaderBtn) {
                vsHeaderBtn.classList.add('countdown');
                vsHeaderBtn.innerHTML = vsCountdown;
            }
            
            // Mostrar mensagem de contagem regressiva
            mostrarMensagemCountdown();
            
            // Iniciar contagem regressiva
            vsCountdownInterval = setInterval(() => {
                vsCountdown--;
                
                // Atualizar bot√µes com o n√∫mero atual
                vsFloatBtn.innerHTML = vsCountdown;
                if (vsHeaderBtn) vsHeaderBtn.innerHTML = vsCountdown;
                
                // Atualizar mensagem
                atualizarMensagemCountdown();
                
                if (vsCountdown <= 0) {
                    clearInterval(vsCountdownInterval);
                    vsCountdownInterval = null;
                    
                    // Remover classe countdown
                    vsFloatBtn.classList.remove('countdown');
                    if (vsHeaderBtn) vsHeaderBtn.classList.remove('countdown');
                    
                    // Iniciar o VS de verdade
                    iniciarVS();
                }
            }, 1000);
        }

        function cancelarCountdownVS() {
            if (vsCountdownInterval) {
                clearInterval(vsCountdownInterval);
                vsCountdownInterval = null;
            }
            
            // Remover mensagem de countdown
            const countdownMsg = document.querySelector('.countdown-message');
            if (countdownMsg) countdownMsg.remove();
            
            // Resetar bot√µes
            const vsFloatBtn = document.getElementById('vs-float-btn');
            const vsHeaderBtn = document.getElementById('vs-header-btn');
            
            vsFloatBtn.classList.remove('countdown');
            vsFloatBtn.innerHTML = 'VS';
            
            if (vsHeaderBtn) {
                vsHeaderBtn.classList.remove('countdown');
                vsHeaderBtn.innerHTML = 'VS';
            }
        }

        function mostrarMensagemCountdown() {
            // Remover mensagem anterior se existir
            const msgAnterior = document.querySelector('.countdown-message');
            if (msgAnterior) msgAnterior.remove();
            
            // Criar nova mensagem
            const msg = document.createElement('div');
            msg.className = 'countdown-message';
            msg.id = 'countdown-message';
            msg.innerHTML = `‚è≥ VS iniciar√° em:<br><span class="countdown-number" id="countdown-number">5</span>`;
            document.body.appendChild(msg);
        }

        function atualizarMensagemCountdown() {
            const countdownNumber = document.getElementById('countdown-number');
            if (countdownNumber) {
                countdownNumber.textContent = vsCountdown;
                
                // Efeito visual a cada segundo
                countdownNumber.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    if (countdownNumber) countdownNumber.style.transform = 'scale(1)';
                }, 200);
            }
        }

        function iniciarVS() {
            if (!musicaVSAberta) return;
            
            const nomeArquivo = formatarNomeArquivoVS(musicaVSAberta.nome);
            const caminhoArquivo = `vs/${nomeArquivo}.mp3`;
            
            console.log('üîç Procurando arquivo VS:', caminhoArquivo);
            
            // Criar elemento de √°udio
            vsAudio = new Audio(caminhoArquivo);
            vsAguardandoArquivo = true;
            
            // Timeout para evitar espera infinita
            const timeoutId = setTimeout(() => {
                if (vsAguardandoArquivo) {
                    console.error('‚ùå Timeout ao carregar VS');
                    vsAudio = null;
                    vsAguardandoArquivo = false;
                    mostrarVSNaoDisponivel();
                }
            }, 3000);
            
            // Verificar se o arquivo existe
            vsAudio.addEventListener('canplaythrough', function() {
                clearTimeout(timeoutId);
                vsAguardandoArquivo = false;
                
                vsAudio.play()
                    .then(() => {
                        vsAtivo = true;
                        atualizarInterfaceVS(true);
                        console.log('‚ñ∂Ô∏è VS tocando:', caminhoArquivo);
                        
                        // Remover mensagem de countdown
                        const countdownMsg = document.querySelector('.countdown-message');
                        if (countdownMsg) countdownMsg.remove();
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao tocar VS:', error);
                        vsAudio = null;
                        vsAguardandoArquivo = false;
                        mostrarVSNaoDisponivel();
                    });
            });
            
            vsAudio.addEventListener('error', function() {
                clearTimeout(timeoutId);
                console.error('‚ùå Arquivo VS n√£o encontrado:', caminhoArquivo);
                vsAudio = null;
                vsAguardandoArquivo = false;
                mostrarVSNaoDisponivel();
            });
        }

        function pararVS() {
            if (vsAudio) {
                vsAudio.pause();
                vsAudio.currentTime = 0;
                vsAudio = null;
            }
            
            if (vsCountdownInterval) {
                clearInterval(vsCountdownInterval);
                vsCountdownInterval = null;
            }
            
            vsAtivo = false;
            vsAguardandoArquivo = false;
            
            // Remover mensagem de countdown
            const countdownMsg = document.querySelector('.countdown-message');
            if (countdownMsg) countdownMsg.remove();
            
            atualizarInterfaceVS(false);
            console.log('‚èπÔ∏è VS parado');
        }

        function atualizarInterfaceVS(ativo) {
            const vsFloatBtn = document.getElementById('vs-float-btn');
            const vsHeaderBtn = document.getElementById('vs-header-btn');
            
            if (ativo) {
                vsFloatBtn.classList.add('playing');
                vsFloatBtn.classList.remove('countdown');
                vsFloatBtn.innerHTML = '‚èπÔ∏è';
                vsFloatBtn.title = 'Virtual Sound - Parar';
                
                if (vsHeaderBtn) {
                    vsHeaderBtn.classList.add('playing');
                    vsHeaderBtn.classList.remove('countdown');
                    vsHeaderBtn.innerHTML = '‚èπÔ∏è';
                }
            } else {
                vsFloatBtn.classList.remove('playing', 'countdown');
                vsFloatBtn.innerHTML = 'VS';
                vsFloatBtn.title = 'Virtual Sound - Tocar faixa de √°udio';
                
                if (vsHeaderBtn) {
                    vsHeaderBtn.classList.remove('playing', 'countdown');
                    vsHeaderBtn.innerHTML = 'VS';
                }
            }
        }

        function mostrarVSNaoDisponivel() {
            // Remover toast anterior se existir
            const toastAnterior = document.querySelector('.vs-toast');
            if (toastAnterior) {
                toastAnterior.remove();
            }
            
            // Remover mensagem de countdown
            const countdownMsg = document.querySelector('.countdown-message');
            if (countdownMsg) countdownMsg.remove();
            
            // Criar novo toast
            const toast = document.createElement('div');
            toast.className = 'vs-toast';
            toast.innerHTML = '‚ùå VS n√£o dispon√≠vel para esta m√∫sica';
            document.body.appendChild(toast);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
            
            // Garantir que o bot√£o n√£o fique como playing
            atualizarInterfaceVS(false);
        }
        // ===== FIM DAS FUN√á√ïES VS =====

        // EVENTOS GLOBAIS - executados apenas uma vez
        function configurarEventosGlobais() {
            // Fechar modais ao clicar fora
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    fecharModal();
                    fecharAddModal();
                    fecharEditModal();
                    fecharConfigModal();
                    fecharNotesModal();
                    fecharImportModal();
                    fecharImportURLModal();
                    fecharUpdateModal();
                    fecharTunerModal();
                    fecharMetronomeModal();
                }
            });

            // Fechar modais com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    fecharModal();
                    fecharAddModal();
                    fecharEditModal();
                    fecharConfigModal();
                    fecharNotesModal();
                    fecharImportModal();
                    fecharImportURLModal();
                    fecharUpdateModal();
                    fecharTunerModal();
                    fecharMetronomeModal();
                    
                    // Fechar bal√£o de notas tamb√©m
                    fecharNotesBubble();
                }
            });

            // Tela cheia autom√°tica em dispositivos m√≥veis
            if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                document.documentElement.requestFullscreen?.();
            }
        }

        // CONFIGURAR EVENTOS DO MODAL - executados quando o modal √© aberto
        function configurarEventosModal() {
            const modalBody = document.querySelector('.modal-body');
            if (modalBody) {
                // Remover event listeners antigos para evitar duplica√ß√£o
                modalBody.replaceWith(modalBody.cloneNode(true));
                
                // Re-aplicar event listeners
                const novoModalBody = document.querySelector('.modal-body');
                
                novoModalBody.addEventListener('wheel', () => {
                    if (autoScrollAtivo) {
                        toggleAutoScroll();
                    }
                });

                novoModalBody.addEventListener('touchstart', () => {
                    if (autoScrollAtivo) {
                        toggleAutoScroll();
                    }
                });

                novoModalBody.addEventListener('scroll', () => {
                    // Se o usu√°rio estiver scrollando manualmente e o auto scroll estiver ativo
                    if (autoScrollAtivo) {
                        // Verificar se o usu√°rio est√° tentando scrollar na dire√ß√£o oposta
                        const lyricsContent = document.getElementById('lyrics-content');
                        const maxScroll = lyricsContent.scrollHeight - novoModalBody.clientHeight;
                        
                        // Se estiver perto do final ou se o scroll manual for significativo, parar auto scroll
                        if (novoModalBody.scrollTop >= maxScroll - 10) {
                            toggleAutoScroll();
                        }
                    }
                });
            }
        }

        function mostrarInterfaceComMusicas() {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('music-list').style.display = 'block';
            document.getElementById('controls').style.display = 'flex';
            exibirListaMusicas();
            atualizarContadorRodape(); // Atualizar o rodap√©
        }

        // FUN√á√ÉO EXIBIR LISTA DE M√öSICAS CORRIGIDA
        function exibirListaMusicas() {
            const lista = document.getElementById('music-list');
            
            if (musicas.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('music-list').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
                atualizarContadorRodape(); // Atualizar o rodap√© mesmo quando vazio
                return;
            }
            
            musicas.sort((a, b) => a.nome.localeCompare(b.nome));
            
            lista.innerHTML = musicas.map((musica, index) => `
                <div class="music-item" onclick="abrirMusica(${index})">
                    <div class="music-info">
                        <div class="music-name">${musica.nome}</div>
                        ${musica.bpm ? `<div class="music-bpm" onclick="event.stopPropagation();" title="BPM da m√∫sica">BPM: ${musica.bpm}</div>` : ''}
                        ${musica.notas ? `<div class="music-notes" onclick="event.stopPropagation(); mostrarNotasModal(${index})" title="Ver notas de execu√ß√£o">üìù</div>` : ''}
                    </div>
                    <div class="music-actions">
                        <button class="action-btn setlist-btn ${musica.noSetlist ? 'active' : ''}" 
                                onclick="event.stopPropagation(); toggleSetlist(${index})" 
                                title="${musica.noSetlist ? 'Remover do setlist' : 'Adicionar ao setlist'}">
                            ${musica.noSetlist ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button class="action-btn edit-btn" onclick="event.stopPropagation(); editarMusicaForm(${index})" title="Editar m√∫sica">‚úèÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            atualizarContadorRodape(); // Atualizar o rodap√©
        }

        // NOVA FUN√á√ÉO PARA ATUALIZAR CONTADOR NO RODAP√â
        function atualizarContadorRodape() {
            const countElement = document.getElementById('music-count-footer');
            const total = musicas.length;
            countElement.textContent = `${total} m√∫sica${total !== 1 ? 's' : ''} no repert√≥rio`;
        }

        // NOVA FUN√á√ÉO PARA MOSTRAR NOTAS USANDO √çNDICE (CORRIGIDA)
        function mostrarNotasModal(index) {
            const musica = musicas[index];
            if (!musica || !musica.notas) return;
            
            document.getElementById('notes-modal-title').textContent = `üìù NOTAS: ${musica.nome}`;
            
            // Converter quebras de linha para <br> e escapar caracteres especiais
            const notasFormatadas = musica.notas
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '<br>');
            
            document.getElementById('notes-content').innerHTML = notasFormatadas;
            document.getElementById('notes-modal').style.display = 'block';
        }

        // FUN√á√ÉO ANTIGA (MANTIDA PARA COMPATIBILIDADE)
        function mostrarNotas(nomeMusica, notas) {
            document.getElementById('notes-modal-title').textContent = `üìù NOTAS: ${nomeMusica}`;
            
            // Converter quebras de linha para <br> e escapar caracteres especiais
            const notasFormatadas = notas
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '<br>');
            
            document.getElementById('notes-content').innerHTML = notasFormatadas;
            document.getElementById('notes-modal').style.display = 'block';
        }

        function fecharNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        function salvarMusicas() {
            localStorage.setItem('catalogoMusicas', JSON.stringify(musicas));
            localStorage.setItem('setlistRepertorio', JSON.stringify(setlist));
            localStorage.setItem('indiceMusicaAtual', indiceMusicaAtual.toString());
            atualizarContadorRodape(); // Atualizar o rodap√© ao salvar
        }

        function mostrarFormulario() {
            document.getElementById('add-form').reset();
            document.getElementById('add-modal').style.display = 'block';
            setTimeout(() => document.getElementById('nome-musica').focus(), 100);
        }

        function fecharAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function adicionarMusica(event) {
            event.preventDefault();
            const nome = document.getElementById('nome-musica').value.trim();
            const letra = document.getElementById('letra-musica').value;
            const bpm = document.getElementById('bpm-musica').value.trim();
            const notas = document.getElementById('notas-musica').value.trim();

            if (!nome || !letra.trim()) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            if (musicas.some(m => m.nome.toUpperCase() === nome.toUpperCase())) {
                alert('‚ùå J√° existe uma m√∫sica com este nome!');
                return;
            }

            const novaMusica = {
                nome: nome.toUpperCase(),
                letra: letra,
                bpm: bpm || null,
                notas: notas || null,
                noSetlist: false,
                dataCriacao: new Date().toISOString()
            };

            musicas.push(novaMusica);
            salvarMusicas();

            if (musicas.length === 1) {
                mostrarInterfaceComMusicas();
            } else {
                exibirListaMusicas();
            }

            // Feedback visual
            const lista = document.getElementById('music-list');
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.innerHTML = `‚úÖ M√∫sica "<strong>${nome}</strong>" adicionada com sucesso!`;
            lista.insertBefore(successMsg, lista.firstChild);
            setTimeout(() => successMsg.remove(), 3000);

            fecharAddModal();
        }

        function editarMusicaForm(index) {
            const musica = musicas[index];
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-nome-musica').value = musica.nome;
            document.getElementById('edit-letra-musica').value = musica.letra;
            document.getElementById('edit-bpm-musica').value = musica.bpm || '';
            document.getElementById('edit-notas-musica').value = musica.notas || '';
            document.getElementById('edit-modal').style.display = 'block';
            setTimeout(() => document.getElementById('edit-nome-musica').focus(), 100);
        }

        function fecharEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function editarMusica(event) {
            event.preventDefault();
            const index = document.getElementById('edit-index').value;
            const nome = document.getElementById('edit-nome-musica').value.trim();
            const letra = document.getElementById('edit-letra-musica').value;
            const bpm = document.getElementById('edit-bpm-musica').value.trim();
            const notas = document.getElementById('edit-notas-musica').value.trim();

            if (!nome || !letra.trim()) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            // Verificar se o nome j√° existe (excluindo a pr√≥pria m√∫sica)
            const nomeExistente = musicas.some((m, i) => 
                i != index && m.nome.toUpperCase() === nome.toUpperCase()
            );

            if (nomeExistente) {
                alert('‚ùå J√° existe uma m√∫sica com este nome!');
                return;
            }

            // Atualizar a m√∫sica
            musicas[index] = {
                ...musicas[index],
                nome: nome.toUpperCase(),
                letra: letra,
                bpm: bpm || null,
                notas: notas || null,
                dataModificacao: new Date().toISOString()
            };

            salvarMusicas();
            exibirListaMusicas();
            exibirSetlist();

            // Feedback visual
            const lista = document.getElementById('music-list');
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.innerHTML = `‚úÖ M√∫sica "<strong>${nome}</strong>" atualizada com sucesso!`;
            lista.insertBefore(successMsg, lista.firstChild);
            setTimeout(() => successMsg.remove(), 3000);

            fecharEditModal();
        }

        // NOVA FUN√á√ÉO PARA EXCLUIR M√öSICA DA TELA DE EDI√á√ÉO
        function excluirMusicaEdicao() {
            const index = document.getElementById('edit-index').value;
            const nomeMusica = musicas[index].nome;
            
            if (confirm(`Tem certeza que deseja excluir permanentemente a m√∫sica "${nomeMusica}"?`)) {
                // Remover do setlist se estiver l√°
                const setlistIndex = setlist.indexOf(parseInt(index));
                if (setlistIndex !== -1) {
                    setlist.splice(setlistIndex, 1);
                    if (indiceMusicaAtual >= setlistIndex) {
                        indiceMusicaAtual = Math.max(-1, indiceMusicaAtual - 1);
                    }
                }
                
                musicas.splice(index, 1);
                salvarMusicas();
                exibirListaMusicas();
                exibirSetlist();
                fecharEditModal();
                
                // Feedback visual
                const lista = document.getElementById('music-list');
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.innerHTML = `‚úÖ M√∫sica "<strong>${nomeMusica}</strong>" exclu√≠da com sucesso!`;
                lista.insertBefore(successMsg, lista.firstChild);
                setTimeout(() => successMsg.remove(), 3000);
            }
        }

        function abrirMusica(index) {
            indiceMusicaAberta = index;
            const musica = musicas[index];
            musicaVSAberta = musica; // Salvar m√∫sica atual para o VS e Notas
            document.getElementById('modal-title').textContent = musica.nome;
            document.getElementById('lyrics-content').innerHTML = formatarLetra(musica.letra);
            document.getElementById('music-modal').style.display = 'block';
            
            // Resetar VS ao abrir nova m√∫sica
            if (vsAtivo || vsCountdownInterval) {
                pararVS();
            }
            
            // Fechar bal√£o de notas ao abrir nova m√∫sica
            fecharNotesBubble();
            
            // Atualizar bot√£o de notas
            atualizarNotesButton();
            
            // Aplicar modo de visualiza√ß√£o salvo
            aplicarModoVisualizacaoAtual();
            
            // Verificar se a m√∫sica est√° no setlist para mostrar os controles de navega√ß√£o
            const setlistIndex = setlist.indexOf(index);
            const footer = document.getElementById('setlist-navigation');
            if (setlistIndex !== -1) {
                footer.style.display = 'block';
                indiceMusicaAtual = setlistIndex;
            } else {
                footer.style.display = 'none';
                indiceMusicaAtual = -1;
            }
            
            // Resetar controles de scroll
            autoScrollAtivo = false;
            pararAutoScroll();
            const scrollToggle = document.getElementById('scroll-toggle');
            if (scrollToggle) {
                scrollToggle.classList.remove('active');
                scrollToggle.innerHTML = '‚ñ∂Ô∏è Scroll';
            }
            const speedControls = document.getElementById('speed-controls');
            if (speedControls) speedControls.style.display = 'none';
            
            // Resetar velocidade para a mais lenta
            scrollSpeed = 1;
            atualizarDisplayVelocidade();
            
            // Resetar metr√¥nomo
            if (metronomeAtivo) {
                pararMetronome();
                const metronomeBtn = document.getElementById('metronome-toggle');
                if (metronomeBtn) metronomeBtn.classList.remove('active');
            }
            
            // Configurar eventos do modal
            setTimeout(() => {
                configurarEventosModal();
                document.querySelector('.modal-body').scrollTop = 0;
                // Ajustar fonte baseada no modo atual
                if (modoVisualizacaoAtual === 'paisagem') {
                    document.getElementById('lyrics-content').style.fontSize = '22px';
                    tamanhoFonteBase = 22;
                } else {
                    document.getElementById('lyrics-content').style.fontSize = '14px';
                    tamanhoFonteBase = 14;
                }
            }, 100);
            
            // Tela cheia autom√°tica ao abrir m√∫sica
            if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                document.documentElement.requestFullscreen?.();
            }
        }

        // FUN√á√ÉO FORMATAR LETRA MODIFICADA - COM SUPORTE PARA CIFRAS LARANJAS
        function formatarLetra(texto) {
            const linhas = texto.split('\n');
            let html = '';
            
            // Fun√ß√£o para processar cifras entre ||
            const processarCifras = (texto) => {
                return texto.replace(/\|([^|]+)\|/g, '<span class="orange-chord">$1</span>');
            };
            
            linhas.forEach(linha => {
                linha = linha.trim();
                if (!linha) {
                    html += '<br>';
                    return;
                }
                
                if (linha.toUpperCase().startsWith('[R]')) {
                    const linhaSemR = linha.substring(3).trim();
                    const linhaComCifras = processarCifras(linhaSemR.toUpperCase());
                    html += `<div class="yellow-line">${linhaComCifras}</div>`;
                } else {
                    const linhaComCifras = processarCifras(linha.toUpperCase());
                    html += `<div class="normal-line">${linhaComCifras}</div>`;
                }
            });
            
            return html;
        }

        function fecharModal() {
            // Parar auto scroll se estiver ativo
            if (autoScrollAtivo) {
                pararAutoScroll();
                autoScrollAtivo = false;
            }
            
            // Parar metr√¥nomo se estiver ativo
            if (metronomeAtivo) {
                pararMetronome();
                const metronomeBtn = document.getElementById('metronome-toggle');
                if (metronomeBtn) metronomeBtn.classList.remove('active');
            }
            
            // Parar VS se estiver tocando ou em contagem
            if (vsAtivo || vsCountdownInterval) {
                pararVS();
            }
            
            // Fechar bal√£o de notas
            fecharNotesBubble();
            
            musicaVSAberta = null;
            document.getElementById('music-modal').style.display = 'none';
        }

        // FUN√á√ïES DE MODOS DE VISUALIZA√á√ÉO - CORRIGIDAS
        function toggleViewMode() {
            const lyricsContent = document.getElementById('lyrics-content');
            const botao = document.getElementById('view-mode-toggle');
            
            if (modoVisualizacaoAtual === 'retrato') {
                modoVisualizacaoAtual = 'paisagem';
                lyricsContent.classList.add('landscape');
                botao.classList.add('active');
                botao.innerHTML = 'üì± Retrato';
                // Ajustar fonte para modo paisagem - TAMANHO REDUZIDO
                lyricsContent.style.fontSize = '22px';
                tamanhoFonteBase = 22;
            } else {
                modoVisualizacaoAtual = 'retrato';
                lyricsContent.classList.remove('landscape');
                botao.classList.remove('active');
                botao.innerHTML = 'üîÑ Paisagem';
                // Ajustar fonte para modo retrato - ALTERADO: de 16px para 14px
                lyricsContent.style.fontSize = '14px';
                tamanhoFonteBase = 14;
            }
            
            localStorage.setItem('modoVisualizacao', modoVisualizacaoAtual);
        }

        function aplicarModoVisualizacaoAtual() {
            const lyricsContent = document.getElementById('lyrics-content');
            const botao = document.getElementById('view-mode-toggle');
            
            if (modoVisualizacaoAtual === 'paisagem') {
                lyricsContent.classList.add('landscape');
                botao.classList.add('active');
                botao.innerHTML = 'üì± Retrato';
                // Ajustar fonte para modo paisagem - TAMANHO REDUZIDO
                lyricsContent.style.fontSize = '22px';
                tamanhoFonteBase = 22;
            } else {
                lyricsContent.classList.remove('landscape');
                botao.classList.remove('active');
                botao.innerHTML = 'üîÑ Paisagem';
                // Ajustar fonte para modo retrato - ALTERADO: de 16px para 14px
                lyricsContent.style.fontSize = '14px';
                tamanhoFonteBase = 14;
            }
        }

        function aplicarModoVisualizacao(modo) {
            modoDispositivo = modo;
            localStorage.setItem('modoDispositivo', modo);
            
            // Aplicar configura√ß√µes espec√≠ficas do modo
            if (modo === 'notebook') {
                // Modo Notebook - padr√£o para paisagem
                modoVisualizacaoAtual = 'paisagem';
                localStorage.setItem('modoVisualizacao', 'paisagem');
            } else {
                // Modo Tablet - padr√£o para retrato
                modoVisualizacaoAtual = 'retrato';
                localStorage.setItem('modoVisualizacao', 'retrato');
            }
            
            // Aplicar visualiza√ß√£o se o modal estiver aberto
            if (document.getElementById('music-modal').style.display === 'block') {
                aplicarModoVisualizacaoAtual();
            }
            
            atualizarBotoesModoDispositivo();
            
            // Feedback visual
            alert(`‚úÖ Modo ${modo === 'notebook' ? 'Notebook' : 'Tablet'} ativado!`);
        }

        function atualizarBotoesModoDispositivo() {
            const tabletBtn = document.getElementById('modo-tablet-btn');
            const notebookBtn = document.getElementById('modo-notebook-btn');
            
            if (modoDispositivo === 'tablet') {
                tabletBtn.classList.add('active');
                notebookBtn.classList.remove('active');
            } else {
                notebookBtn.classList.add('active');
                tabletBtn.classList.remove('active');
            }
        }

        // FUN√á√ïES DOS AFINADORES
        function abrirTuner(tipo) {
            document.getElementById('tuner-modal').style.display = 'block';
            mudarTipoTuner(tipo);
        }

        function fecharTunerModal() {
            document.getElementById('tuner-modal').style.display = 'none';
            pararTodasNotas();
        }

        function mudarTipoTuner(tipo) {
            tipoTunerAtual = tipo;
            
            // Atualizar bot√µes de sele√ß√£o
            document.getElementById('tuner-bass-btn').classList.remove('active');
            document.getElementById('tuner-guitar-btn').classList.remove('active');
            document.getElementById(`tuner-${tipo}-btn`).classList.add('active');
            
            // Mostrar/ocultar conte√∫do
            document.getElementById('tuner-bass').style.display = tipo === 'bass' ? 'block' : 'none';
            document.getElementById('tuner-guitar').style.display = tipo === 'guitar' ? 'block' : 'none';
            
            // Atualizar t√≠tulo
            document.getElementById('tuner-modal-title').textContent = 
                tipo === 'bass' ? 'üé∏ AFINADOR DE BAIXO' : 'üé∂ AFINADOR DE GUITARRA';
            
            // Parar notas atuais
            pararTodasNotas();
        }

        function tocarNota(nota, tipo) {
            // Parar nota atual se estiver tocando
            pararTodasNotas();
            
            // Obter frequ√™ncia da nota
            const frequencia = frequencias[tipo][nota];
            
            if (!frequencia) {
                console.error('Frequ√™ncia n√£o encontrada para a nota:', nota);
                return;
            }
            
            // Criar contexto de √°udio se n√£o existir
            if (!tunerAudioContext) {
                tunerAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // Criar oscilador
            tunerOscillator = tunerAudioContext.createOscillator();
            const gainNode = tunerAudioContext.createGain();
            
            // Configurar oscilador
            tunerOscillator.type = 'sine'; // Onda senoidal para som puro
            tunerOscillator.frequency.setValueAtTime(frequencia, tunerAudioContext.currentTime);
            
            // Configurar ganho (volume)
            gainNode.gain.setValueAtTime(0.3, tunerAudioContext.currentTime); // Volume moderado
            
            // Conectar e iniciar
            tunerOscillator.connect(gainNode);
            gainNode.connect(tunerAudioContext.destination);
            tunerOscillator.start();
            
            // Salvar nota atual
            notaAtual = nota;
            
            // Atualizar visual do bot√£o
            const botaoAtual = event.target.closest('.string-btn');
            if (botaoAtual) {
                botaoAtual.classList.add('playing');
            }
            
            console.log(`üéµ Tocando nota: ${nota} (${frequencia} Hz)`);
        }

        function pararTodasNotas() {
            if (tunerOscillator) {
                tunerOscillator.stop();
                tunerOscillator.disconnect();
                tunerOscillator = null;
            }
            
            // Remover classe playing de todos os bot√µes
            document.querySelectorAll('.string-btn.playing').forEach(botao => {
                botao.classList.remove('playing');
            });
            
            notaAtual = null;
        }

        // FUN√á√ïES DE BACKUP EM XML
        function exportarDados() {
            // Criar estrutura XML
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<repertorio>\n';
            xml += `  <info>\n`;
            xml += `    <aplicacao>Repert√≥rio BlueVox</aplicacao>\n`;
            xml += `    <versao>2.0</versao>\n`; // ATUALIZADO PARA 2.0
            xml += `    <dataExportacao>${new Date().toISOString()}</dataExportacao>\n`;
            xml += `    <totalMusicas>${musicas.length}</totalMusicas>\n`;
            xml += `  </info>\n`;
            xml += `  <musicas>\n`;
            
            // Adicionar cada m√∫sica
            musicas.forEach(musica => {
                xml += `    <musica>\n`;
                xml += `      <nome><![CDATA[${musica.nome}]]></nome>\n`;
                xml += `      <letra><![CDATA[${musica.letra}]]></letra>\n`;
                if (musica.bpm) {
                    xml += `      <bpm>${musica.bpm}</bpm>\n`;
                }
                if (musica.notas) {
                    xml += `      <notas><![CDATA[${musica.notas}]]></notas>\n`;
                }
                xml += `      <dataCriacao>${musica.dataCriacao || ''}</dataCriacao>\n`;
                if (musica.dataModificacao) {
                    xml += `      <dataModificacao>${musica.dataModificacao}</dataModificacao>\n`;
                }
                xml += `    </musica>\n`;
            });
            
            xml += `  </musicas>\n`;
            xml += `</repertorio>`;
            
            // Criar e baixar arquivo
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repertorio-bluevox-${new Date().toISOString().split('T')[0]}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`üì§ Backup XML exportado com sucesso!\n${musicas.length} m√∫sica(s) salvas.`);
        }

        // FUN√á√ïES DE IMPORTAR VIA URL
        function mostrarImportacaoURL() {
            document.getElementById('import-url-modal').style.display = 'block';
            document.getElementById('url-xml').value = '';
            document.getElementById('url-loading').style.display = 'none';
            setTimeout(() => document.getElementById('url-xml').focus(), 100);
        }

        function fecharImportURLModal() {
            if (importacaoURLEmAndamento) {
                if (!confirm('Deseja continuar?')) {
                    return;
                }
            }
            document.getElementById('import-url-modal').style.display = 'none';
            importacaoURLEmAndamento = false;
        }

        async function importarDeURL(event) {
            event.preventDefault();
            
            const urlInput = document.getElementById('url-xml').value.trim();
            
            if (!urlInput) {
                alert('‚ùå Por favor, digite uma URL v√°lida.');
                return;
            }
            
            // Validar formato da URL
            if (!urlInput.startsWith('http://') && !urlInput.startsWith('https://')) {
                alert('‚ùå A URL deve come√ßar com http:// ou https://');
                return;
            }
            
            try {
                // Mostrar loading
                document.getElementById('url-loading').style.display = 'block';
                importacaoURLEmAndamento = true;
                
                console.log('üåê Iniciando importa√ß√£o da URL:', urlInput);
                
                // Fazer requisi√ß√£o para a URL
                const response = await fetch(urlInput);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                
                // Verificar se o conte√∫do √© XML
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/xml') && !contentType.includes('text/xml')) {
                    console.warn('Content-Type n√£o √© XML:', contentType);
                    // Continuamos mesmo assim, pois alguns servidores podem n√£o configurar o content-type corretamente
                }
                
                const xmlText = await response.text();
                
                if (!xmlText || xmlText.trim().length === 0) {
                    throw new Error('O arquivo da URL est√° vazio');
                }
                
                // Processar o XML (reutilizando a l√≥gica existente)
                processarXMLImportado(xmlText, `URL: ${urlInput}`);
                
            } catch (error) {
                console.error('‚ùå Erro na importa√ß√£o via URL:', error);
                
                let mensagemErro = 'Erro ao importar da URL: ';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    mensagemErro += 'N√£o foi poss√≠vel conectar ao servidor. Verifique a URL e sua conex√£o com a internet.';
                } else if (error.message.includes('404')) {
                    mensagemErro += 'Arquivo n√£o encontrado (404). Verifique se a URL est√° correta.';
                } else if (error.message.includes('403')) {
                    mensagemErro += 'Acesso negado (403). O servidor pode estar bloqueando o acesso.';
                } else if (error.message.includes('CORS')) {
                    mensagemErro += 'Bloqueado por pol√≠tica CORS. O servidor n√£o permite acesso de outros dom√≠nios.';
                } else {
                    mensagemErro += error.message;
                }
                
                alert('‚ùå ' + mensagemErro);
            } finally {
                // Esconder loading
                document.getElementById('url-loading').style.display = 'none';
                importacaoURLEmAndamento = false;
            }
        }

        // Fun√ß√£o para processar XML importado (reutiliz√°vel para arquivo e URL)
        function processarXMLImportado(xmlText, fonte) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                // Verificar se √© um XML v√°lido
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error('XML malformado ou inv√°lido');
                }
                
                // Verificar se √© um backup do Repert√≥rio BlueVox
                const aplicacao = xmlDoc.querySelector('aplicacao');
                if (!aplicacao || aplicacao.textContent !== 'Repert√≥rio BlueVox') {
                    // Tentar uma verifica√ß√£o mais flex√≠vel
                    const musicasNodes = xmlDoc.querySelectorAll('musica');
                    if (musicasNodes.length === 0) {
                        throw new Error('Arquivo XML n√£o √© um backup v√°lido do Repert√≥rio BlueVox');
                    }
                    console.warn('‚ö†Ô∏è Arquivo XML pode n√£o ser um backup oficial do BlueVox, mas tentando importar...');
                }
                
                // Extrair m√∫sicas do XML
                const musicasNodes = xmlDoc.querySelectorAll('musica');
                const musicasImportadas = [];
                
                musicasNodes.forEach(musicaNode => {
                    const nome = musicaNode.querySelector('nome')?.textContent || '';
                    const letra = musicaNode.querySelector('letra')?.textContent || '';
                    const bpm = musicaNode.querySelector('bpm')?.textContent || '';
                    const notas = musicaNode.querySelector('notas')?.textContent || '';
                    const dataCriacao = musicaNode.querySelector('dataCriacao')?.textContent || new Date().toISOString();
                    
                    if (nome && letra) {
                        musicasImportadas.push({
                            nome: nome,
                            letra: letra,
                            bpm: bpm || null,
                            notas: notas || null,
                            noSetlist: false,
                            dataCriacao: dataCriacao,
                            fonte: fonte
                        });
                    }
                });
                
                if (musicasImportadas.length === 0) {
                    throw new Error('Nenhuma m√∫sica v√°lida encontrada no arquivo');
                }

                // Salvar dados para uso posterior
                dadosImportacao = musicasImportadas;
                
                // Mostrar modal de op√ß√µes de importa√ß√£o
                mostrarOpcoesImportacao(musicasImportadas.length);
                
                // Fechar modal de URL se estiver aberto
                fecharImportURLModal();

            } catch (error) {
                console.error('Erro ao processar XML:', error);
                alert(`‚ùå Erro ao processar o arquivo da URL!\n${error.message}`);
            }
        }

        function iniciarImportacao(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de arquivo
            if (!file.name.toLowerCase().endsWith('.xml')) {
                alert('‚ùå Por favor, selecione um arquivo XML v√°lido.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                processarXMLImportado(e.target.result, `Arquivo: ${file.name}`);
            };
            
            reader.onerror = function() {
                alert('‚ùå Erro ao ler o arquivo. Tente novamente.');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function mostrarOpcoesImportacao(quantidadeMusicas) {
            document.getElementById('import-count').textContent = quantidadeMusicas;
            document.getElementById('import-modal').style.display = 'block';
            
            // Resetar sele√ß√£o
            opcaoImportSelecionada = null;
            document.querySelectorAll('.import-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('confirm-import-btn').disabled = true;
        }

        function fecharImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            dadosImportacao = null;
            opcaoImportSelecionada = null;
            
            // Limpar inputs
            document.getElementById('file-input').value = '';
            document.getElementById('file-input-initial').value = '';
        }

        function selecionarOpcaoImport(opcao) {
            opcaoImportSelecionada = opcao;
            
            // Atualizar visualmente a sele√ß√£o
            document.querySelectorAll('.import-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(`option-${opcao}`).classList.add('selected');
            
            // Habilitar bot√£o de confirma√ß√£o
            document.getElementById('confirm-import-btn').disabled = false;
        }

        function confirmarImportacao() {
            if (!dadosImportacao || !opcaoImportSelecionada) {
                alert('‚ùå Selecione uma op√ß√£o de importa√ß√£o.');
                return;
            }

            let mensagem = '';
            let musicasAdicionadas = 0;
            let musicasAtualizadas = 0;

            switch (opcaoImportSelecionada) {
                case 'substituir':
                    // Substituir tudo
                    musicas = dadosImportacao;
                    setlist = [];
                    indiceMusicaAtual = -1;
                    mensagem = `‚úÖ Backup importado! ${musicas.length} m√∫sica(s) carregadas.`;
                    break;
                    
                case 'adicionar':
                    // Adicionar apenas novas
                    const musicasExistentes = new Set(musicas.map(m => m.nome.toUpperCase()));
                    const novasMusicas = dadosImportacao.filter(m => 
                        !musicasExistentes.has(m.nome.toUpperCase())
                    );
                    
                    if (novasMusicas.length === 0) {
                        alert('‚ÑπÔ∏è Todas as m√∫sicas do backup j√° existem no repert√≥rio.');
                        fecharImportModal();
                        return;
                    }
                    
                    musicas.push(...novasMusicas);
                    musicasAdicionadas = novasMusicas.length;
                    mensagem = `‚úÖ Backup importado! ${musicasAdicionadas} nova(s) m√∫sica(s) adicionadas.`;
                    break;
                    
                case 'mesclar':
                    // Mesclar tudo - combinar e atualizar
                    const mapaMusicas = new Map();
                    
                    // Primeiro, adicionar todas as m√∫sicas atuais ao mapa
                    musicas.forEach(musica => {
                        mapaMusicas.set(musica.nome.toUpperCase(), musica);
                    });
                    
                    // Depois, adicionar/atualizar com as m√∫sicas do backup
                    dadosImportacao.forEach(musicaBackup => {
                        const chave = musicaBackup.nome.toUpperCase();
                        if (mapaMusicas.has(chave)) {
                            // Atualizar m√∫sica existente
                            const musicaExistente = mapaMusicas.get(chave);
                            mapaMusicas.set(chave, {
                                ...musicaExistente,
                                letra: musicaBackup.letra,
                                bpm: musicaBackup.bpm || musicaExistente.bpm,
                                notas: musicaBackup.notas || musicaExistente.notas,
                                dataModificacao: new Date().toISOString()
                            });
                            musicasAtualizadas++;
                        } else {
                            // Adicionar nova m√∫sica
                            mapaMusicas.set(chave, musicaBackup);
                            musicasAdicionadas++;
                        }
                    });
                    
                    // Converter mapa de volta para array
                    musicas = Array.from(mapaMusicas.values());
                    mensagem = `‚úÖ Backup mesclado! ${musicasAdicionadas} nova(s) m√∫sica(s) adicionadas e ${musicasAtualizadas} m√∫sica(s) atualizadas.`;
                    break;
            }

            salvarMusicas();
            exibirListaMusicas();
            exibirSetlist();
            
            if (musicas.length > 0) {
                mostrarInterfaceComMusicas();
            }

            // Feedback visual
            const lista = document.getElementById('music-list');
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.innerHTML = mensagem;
            lista.insertBefore(successMsg, lista.firstChild);
            setTimeout(() => successMsg.remove(), 5000);

            fecharImportModal();
        }

        // FUN√á√ïES DE UPDATE DO REPERT√ìRIO
        async function verificarAtualizacoes() {
            try {
                console.log('üîÑ Verificando atualiza√ß√µes do repert√≥rio...');
                
                const response = await fetch(REPERTORIO_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                // Verificar se √© um XML v√°lido
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error('XML malformado ou inv√°lido');
                }
                
                // Extrair m√∫sicas do XML
                const musicasNodes = xmlDoc.querySelectorAll('musica');
                const musicasOnline = [];
                
                musicasNodes.forEach(musicaNode => {
                    const nome = musicaNode.querySelector('nome')?.textContent || '';
                    const letra = musicaNode.querySelector('letra')?.textContent || '';
                    const bpm = musicaNode.querySelector('bpm')?.textContent || '';
                    const notas = musicaNode.querySelector('notas')?.textContent || '';
                    
                    if (nome && letra) {
                        musicasOnline.push({
                            nome: nome,
                            letra: letra,
                            bpm: bpm || null,
                            notas: notas || null
                        });
                    }
                });
                
                if (musicasOnline.length === 0) {
                    throw new Error('Nenhuma m√∫sica v√°lida encontrada no repert√≥rio online');
                }
                
                // Salvar hash do repert√≥rio online para compara√ß√£o futura
                const hashOnline = calcularHash(musicasOnline);
                const hashSalvo = localStorage.getItem('repertorioHash');
                
                console.log('üîç Hash do repert√≥rio online:', hashOnline);
                console.log('üîç Hash do repert√≥rio salvo:', hashSalvo);
                
                // Se n√£o h√° hash salvo ou se o hash √© diferente, mostrar alerta
                if (!hashSalvo || hashSalvo !== hashOnline) {
                    console.log('üÜï Atualiza√ß√£o dispon√≠vel!');
                    localStorage.setItem('repertorioOnline', JSON.stringify(musicasOnline));
                    mostrarAlertaAtualizacao();
                } else {
                    console.log('‚úÖ Repert√≥rio est√° atualizado');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar atualiza√ß√µes:', error);
                // N√£o mostrar erro para o usu√°rio para n√£o poluir a experi√™ncia
            }
        }

        function calcularHash(musicasArray) {
            // Criar uma string √∫nica baseada nas m√∫sicas para compara√ß√£o
            const dados = musicasArray.map(m => `${m.nome}${m.letra}${m.bpm || ''}${m.notas || ''}`).join('');
            let hash = 0;
            for (let i = 0; i < dados.length; i++) {
                const char = dados.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        function mostrarAlertaAtualizacao() {
            const alertElement = document.getElementById('update-alert');
            if (alertElement) {
                alertElement.style.display = 'block';
            }
        }

        function mostrarOpcoesUpdate() {
            // Tentar carregar dados online salvos
            const musicasOnlineSalvas = localStorage.getItem('repertorioOnline');
            let musicasOnline = [];
            
            if (musicasOnlineSalvas) {
                try {
                    musicasOnline = JSON.parse(musicasOnlineSalvas);
                } catch (e) {
                    console.error('Erro ao carregar repert√≥rio online salvo:', e);
                }
            }
            
            // Se n√£o h√° dados salvos, buscar online
            if (musicasOnline.length === 0) {
                buscarRepertorioOnline();
                return;
            }
            
            document.getElementById('update-count').textContent = musicasOnline.length;
            document.getElementById('update-modal').style.display = 'block';
            
            // Resetar sele√ß√£o
            document.querySelectorAll('.import-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('confirm-update-btn').disabled = true;
        }

        async function buscarRepertorioOnline() {
            try {
                console.log('üåê Buscando repert√≥rio online...');
                
                const response = await fetch(REPERTORIO_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                // Verificar se √© um XML v√°lido
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error('XML malformado ou inv√°lido');
                }
                
                // Extrair m√∫sicas do XML
                const musicasNodes = xmlDoc.querySelectorAll('musica');
                const musicasOnline = [];
                
                musicasNodes.forEach(musicaNode => {
                    const nome = musicaNode.querySelector('nome')?.textContent || '';
                    const letra = musicaNode.querySelector('letra')?.textContent || '';
                    const bpm = musicaNode.querySelector('bpm')?.textContent || '';
                    const notas = musicaNode.querySelector('notas')?.textContent || '';
                    
                    if (nome && letra) {
                        musicasOnline.push({
                            nome: nome,
                            letra: letra,
                            bpm: bpm || null,
                            notas: notas || null
                        });
                    }
                });
                
                if (musicasOnline.length === 0) {
                    throw new Error('Nenhuma m√∫sica v√°lida encontrada no repert√≥rio online');
                }
                
                // Salvar dados online
                localStorage.setItem('repertorioOnline', JSON.stringify(musicasOnline));
                
                // Mostrar modal de op√ß√µes
                document.getElementById('update-count').textContent = musicasOnline.length;
                document.getElementById('update-modal').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar repert√≥rio online:', error);
                alert(`‚ùå Erro ao buscar repert√≥rio online:\n${error.message}`);
            }
        }

        function fecharUpdateModal() {
            document.getElementById('update-modal').style.display = 'none';
        }

        function selecionarOpcaoUpdate(opcao) {
            // Atualizar visualmente a sele√ß√£o
            document.querySelectorAll('.import-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(`update-option-${opcao}`).classList.add('selected');
            
            // Habilitar bot√£o de confirma√ß√£o
            document.getElementById('confirm-update-btn').disabled = false;
        }

        function confirmarUpdate() {
            const opcaoSelecionada = document.querySelector('#update-modal .import-option.selected');
            if (!opcaoSelecionada) {
                alert('‚ùå Selecione uma op√ß√£o de update.');
                return;
            }
            
            const opcao = opcaoSelecionada.id.replace('update-option-', '');
            const musicasOnlineSalvas = localStorage.getItem('repertorioOnline');
            
            if (!musicasOnlineSalvas) {
                alert('‚ùå Dados do repert√≥rio online n√£o encontrados. Tente novamente.');
                return;
            }
            
            try {
                const musicasOnline = JSON.parse(musicasOnlineSalvas);
                let mensagem = '';
                let musicasAdicionadas = 0;
                let musicasAtualizadas = 0;

                switch (opcao) {
                    case 'substituir':
                        // Substituir tudo
                        musicas = musicasOnline;
                        setlist = [];
                        indiceMusicaAtual = -1;
                        mensagem = `‚úÖ Repert√≥rio atualizado! ${musicas.length} m√∫sica(s) carregadas.`;
                        break;
                        
                    case 'mesclar':
                        // Mesclar tudo - combinar e atualizar
                        const mapaMusicas = new Map();
                        
                        // Primeiro, adicionar todas as m√∫sicas atuais ao mapa
                        musicas.forEach(musica => {
                            mapaMusicas.set(musica.nome.toUpperCase(), musica);
                        });
                        
                        // Depois, adicionar/atualizar com as m√∫sicas online
                        musicasOnline.forEach(musicaOnline => {
                            const chave = musicaOnline.nome.toUpperCase();
                            if (mapaMusicas.has(chave)) {
                                // Atualizar m√∫sica existente
                                const musicaExistente = mapaMusicas.get(chave);
                                mapaMusicas.set(chave, {
                                    ...musicaExistente,
                                    letra: musicaOnline.letra,
                                    bpm: musicaOnline.bpm || musicaExistente.bpm,
                                    notas: musicaOnline.notas || musicaExistente.notas,
                                    dataModificacao: new Date().toISOString()
                                });
                                musicasAtualizadas++;
                            } else {
                                // Adicionar nova m√∫sica
                                mapaMusicas.set(chave, musicaOnline);
                                musicasAdicionadas++;
                            }
                        });
                        
                        // Converter mapa de volta para array
                        musicas = Array.from(mapaMusicas.values());
                        mensagem = `‚úÖ Repert√≥rio mesclado! ${musicasAdicionadas} nova(s) m√∫sica(s) adicionadas e ${musicasAtualizadas} m√∫sica(s) atualizadas.`;
                        break;
                }

                // Atualizar hash do repert√≥rio
                const hashOnline = calcularHash(musicasOnline);
                localStorage.setItem('repertorioHash', hashOnline);
                
                // Esconder alerta de atualiza√ß√£o
                document.getElementById('update-alert').style.display = 'none';
                
                salvarMusicas();
                exibirListaMusicas();
                exibirSetlist();
                
                if (musicas.length > 0) {
                    mostrarInterfaceComMusicas();
                }

                // Feedback visual
                const lista = document.getElementById('music-list');
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.innerHTML = mensagem;
                lista.insertBefore(successMsg, lista.firstChild);
                setTimeout(() => successMsg.remove(), 5000);

                fecharUpdateModal();
                
            } catch (error) {
                console.error('Erro ao processar update:', error);
                alert(`‚ùå Erro ao processar update:\n${error.message}`);
            }
        }

        // FUN√á√ïES DO SETLIST
        function toggleSetlist(index) {
            const musica = musicas[index];
            
            if (musica.noSetlist) {
                // Remover do setlist
                musica.noSetlist = false;
                const setlistIndex = setlist.indexOf(index);
                if (setlistIndex !== -1) {
                    setlist.splice(setlistIndex, 1);
                    // Ajustar √≠ndice atual se necess√°rio
                    if (indiceMusicaAtual >= setlistIndex) {
                        indiceMusicaAtual = Math.max(-1, indiceMusicaAtual - 1);
                    }
                }
            } else {
                // Adicionar ao setlist
                musica.noSetlist = true;
                setlist.push(index);
            }
            
            salvarMusicas();
            exibirListaMusicas();
            exibirSetlist();
        }

        function exibirSetlist() {
            const setlistContainer = document.getElementById('setlist-container');
            if (!setlistContainer) return;
            
            if (setlist.length === 0) {
                setlistContainer.style.display = 'none';
                return;
            }
            
            setlistContainer.style.display = 'block';
            const setlistElement = document.getElementById('setlist-musicas');
            
            setlistElement.innerHTML = setlist.map((index, posicao) => {
                const musica = musicas[index];
                return `
                    <div class="setlist-item ${posicao === indiceMusicaAtual ? 'active' : ''}" 
                         onclick="abrirMusicaSetlist(${index}, ${posicao})">
                        <div class="setlist-pos">${posicao + 1}</div>
                        <div class="setlist-name">${musica.nome}</div>
                        ${musica.bpm ? `<div class="setlist-bpm">BPM: ${musica.bpm}</div>` : ''}
                        <button class="action-btn delete-btn" onclick="event.stopPropagation(); removerDoSetlist(${posicao})" title="Remover do setlist">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function abrirMusicaSetlist(index, posicao) {
            indiceMusicaAtual = posicao;
            abrirMusica(index);
            exibirSetlist();
        }

        function removerDoSetlist(posicao) {
            const index = setlist[posicao];
            if (musicas[index]) {
                musicas[index].noSetlist = false;
            }
            setlist.splice(posicao, 1);
            
            // Ajustar √≠ndice atual se necess√°rio
            if (indiceMusicaAtual >= posicao) {
                indiceMusicaAtual = Math.max(-1, indiceMusicaAtual - 1);
            }
            
            salvarMusicas();
            exibirListaMusicas();
            exibirSetlist();
        }

        function proximaMusica() {
            if (setlist.length === 0) {
                alert('Nenhuma m√∫sica no setlist!');
                return;
            }
            
            if (indiceMusicaAtual === -1) {
                // Come√ßar do in√≠cio
                indiceMusicaAtual = 0;
            } else {
                // Pr√≥xima m√∫sica
                indiceMusicaAtual = (indiceMusicaAtual + 1) % setlist.length;
            }
            
            const index = setlist[indiceMusicaAtual];
            abrirMusica(index);
            exibirSetlist();
        }

        function musicaAnterior() {
            if (setlist.length === 0) {
                alert('Nenhuma m√∫sica no setlist!');
                return;
            }
            
            if (indiceMusicaAtual === -1) {
                // Come√ßar do final
                indiceMusicaAtual = setlist.length - 1;
            } else {
                // M√∫sica anterior
                indiceMusicaAtual = (indiceMusicaAtual - 1 + setlist.length) % setlist.length;
            }
            
            const index = setlist[indiceMusicaAtual];
            abrirMusica(index);
            exibirSetlist();
        }

        function limparSetlist() {
            if (confirm('Tem certeza que deseja limpar todo o setlist?')) {
                // Remover flag de todas as m√∫sicas
                setlist.forEach(index => {
                    if (musicas[index]) {
                        musicas[index].noSetlist = false;
                    }
                });
                
                setlist = [];
                indiceMusicaAtual = -1;
                salvarMusicas();
                exibirListaMusicas();
                exibirSetlist();
            }
        }

        // FUN√á√ÉO PARA RESETAR O APLICATIVO
        function resetarAplicativo() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ir√° apagar TODOS os dados do aplicativo, incluindo:\n\n‚Ä¢ Todas as m√∫sicas do repert√≥rio\n‚Ä¢ Configura√ß√µes salvas\n‚Ä¢ Hist√≥rico de atualiza√ß√µes\n‚Ä¢ Setlist atual\n\nTem certeza que deseja resetar o aplicativo?')) {
                // Limpar todos os dados do localStorage
                localStorage.clear();
                
                // Recarregar a p√°gina para aplicar o reset
                alert('‚úÖ Aplicativo resetado com sucesso!\n\nA p√°gina ser√° recarregada.');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        function mostrarAjuda() {
            alert(`üéµ AJUDA - REPERT√ìRIO BLUEVOX

üëÅÔ∏è VISUALIZAR M√öSICA:
‚Ä¢ A- A A+ = Controles de tamanho da fonte (agora funcionam em ambos os modos)
‚Ä¢ ‚ñ∂Ô∏è Scroll = Auto scroll autom√°tico (inicia ap√≥s 10 segundos)
‚Ä¢ - 1 + = Controles simples de velocidade (1-7, inicia na mais lenta)
‚Ä¢ ‚ô´ Metr√¥nomo = Inicia/para metr√¥nomo no BPM da m√∫sica (requer BPM definido)
‚Ä¢ ‚èÆÔ∏è ‚è≠Ô∏è = Navega√ß√£o no setlist durante apresenta√ß√£o (bot√µes compactos)
‚Ä¢ üîÑ Visualiza√ß√£o = Alternar entre modo Retrato e Paisagem (colunas)

‚ûï ADICIONAR M√öSICA:
‚Ä¢ Clique em "Adicionar M√∫sica"
‚Ä¢ Digite o nome, BPM (opcional), notas (opcional) e cole a letra
‚Ä¢ Use [R] para linhas em AMARELO
‚Ä¢ Use |D|, |G|, |C#m| para cifras em LARANJA

‚úèÔ∏è EDITAR M√öSICA:
‚Ä¢ Clique no √≠cone ‚úèÔ∏è ao lado da m√∫sica
‚Ä¢ Altere o nome, BPM, notas e/ou letra
‚Ä¢ Salve as altera√ß√µes
‚Ä¢ Use o bot√£o "üóëÔ∏è Excluir M√∫sica" para remover a m√∫sica

üìù NOTAS DE EXECU√á√ÉO:
‚Ä¢ Bot√£o flutuante üìù acima do VS mostra as notas em um bal√£o
‚Ä¢ Bal√£o tem seta apontando para o bot√£o
‚Ä¢ Clique novamente para fechar, ou clique fora
‚Ä¢ Se n√£o houver notas, bot√£o fica mais fraco

‚ô´ METR√îNOMO:
‚Ä¢ Clique no bot√£o ‚ô´ para iniciar/parar
‚Ä¢ Usa o BPM definido na m√∫sica
‚Ä¢ Som com batida forte na primeira de cada 4 tempos
‚Ä¢ Funciona apenas se a m√∫sica tiver BPM definido

üéß VIRTUAL SOUND (VS):
‚Ä¢ Bot√£o flutuante VS na parte inferior
‚Ä¢ Ao clicar, inicia contagem regressiva de 5 segundos (5,4,3,2,1) no pr√≥prio bot√£o
‚Ä¢ Ap√≥s a contagem, toca o arquivo MP3 correspondente da pasta "vs"
‚Ä¢ Nome do arquivo deve seguir o formato: nome-da-musica.mp3
‚Ä¢ Exemplo: "N√ÉO TENHO COMO PAGAR" ‚Üí "nao-tenho-como-pagar.mp3"
‚Ä¢ Mensagem de "VS n√£o dispon√≠vel" se o arquivo n√£o existir
‚Ä¢ Clique novamente durante a contagem para cancelar

üõ†Ô∏è UTILIT√ÅRIOS:
‚Ä¢ üé∏ Afinador de Baixo = Notas de refer√™ncia para baixo 4 cordas (E-A-D-G)
‚Ä¢ üé∂ Afinador de Guitarra = Notas de refer√™ncia para guitarra 6 cordas (E-A-D-G-B-E)
‚Ä¢ ‚ô´ Metr√¥nomo Independente = Metr√¥nomo com BPM ajust√°vel e pr√©-contagem
‚Ä¢ Clique em uma corda para tocar a nota de refer√™ncia
‚Ä¢ Use "Parar Todas as Notas" para silenciar

üì±üíª MODOS DE VISUALIZA√á√ÉO:
‚Ä¢ Modo Tablet = Visualiza√ß√£o em retrato, ideal para tablets e celulares
‚Ä¢ Modo Notebook = Visualiza√ß√£o em paisagem com colunas, ideal para notebooks

‚≠ê SETLIST (REPERT√ìRIO DE SHOW):
‚Ä¢ Clique na estrela ‚òÜ para adicionar m√∫sica ao setlist
‚Ä¢ A estrela ficar√° ‚≠ê quando a m√∫sica estiver no setlist
‚Ä¢ Use os bot√µes ‚èÆÔ∏è e ‚è≠Ô∏è para navegar durante o show
‚Ä¢ Use "Limpar Setlist" para remover todas as m√∫sicas

üíæ BACKUP:
‚Ä¢ EXPORTAR: Gera arquivo XML universal
‚Ä¢ IMPORTAR: Carrega backup XML (arquivo ou URL)
‚Ä¢ Formatos suportados: Substituir, Adicionar, Mesclar

üîÑ UPDATE DO REPERT√ìRIO:
‚Ä¢ Busca atualiza√ß√µes do repert√≥rio online
‚Ä¢ Op√ß√µes: Substituir tudo ou Mesclar
‚Ä¢ Verifica√ß√£o autom√°tica na inicializa√ß√£o

üåê IMPORTAR DE URL:
‚Ä¢ Digite a URL completa do arquivo XML
‚Ä¢ Suporta http:// e https://
‚Ä¢ Funciona com qualquer servidor p√∫blico

üé® PERSONALIZAR:
‚Ä¢ Bot√£o "Cores" para mudar o tema
‚Ä¢ 5 temas diferentes dispon√≠veis

üóëÔ∏è RESETAR APP:
‚Ä¢ Apaga todos os dados do aplicativo
‚Ä¢ Reinicia completamente o sistema

üì± INSTALA√á√ÉO:
‚Ä¢ Adicione √† tela inicial para acesso r√°pido
‚Ä¢ Funciona 100% offline
‚Ä¢ Dados salvos no navegador

‚è∞ AUTO SCROLL:
‚Ä¢ Inicia automaticamente ap√≥s 10 segundos
‚Ä¢ 7 velocidades diferentes (inicia na mais lenta)
‚Ä¢ Controles simples com - e +
‚Ä¢ Mais op√ß√µes de velocidade lenta para melhor controle

üí° DICAS DE FORMATA√á√ÉO:
‚Ä¢ [R] no in√≠cio da linha ‚Üí linha inteira em AMARELO
‚Ä¢ |D|, |G|, |C#m| em qualquer lugar ‚Üí cifra em LARANJA
‚Ä¢ Combine ambos: [R] linha com |D| cifra |G|`);
        }
    </script>
</body>
</html>
